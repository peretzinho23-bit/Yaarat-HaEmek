<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>××©×™××•×ª ×œ×›×™×ª×” Â· ×™×¢×¨×ª ×”×¢××§</title>
  <style>
    :root{
      --bg:#0b1020; --line:rgba(255,255,255,.12);
      --card:rgba(255,255,255,.06); --text:#eaf0ff; --muted:rgba(234,240,255,.72);
      --accent:#4f8cff; --good:#16a34a; --warn:#f59e0b;
      --r:18px; --r2:14px; --w:1100px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 600px at 85% -10%, rgba(79,140,255,.35), transparent 55%),
        radial-gradient(900px 500px at 15% 0%, rgba(22,163,74,.22), transparent 55%),
        linear-gradient(180deg,#070a12,#0b1020 60%,#060813);
      min-height:100svh;
    }
    .wrap{max-width:var(--w); margin:0 auto; padding:18px 14px 60px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 14px; border:1px solid var(--line);
      background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));
      border-radius:var(--r); position:sticky; top:12px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,rgba(79,140,255,.95),rgba(22,163,74,.85))}
    h1{margin:0;font-size:16px;font-weight:900}
    .sub{margin:0;font-size:12px;color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      border:1px solid var(--line); background:rgba(255,255,255,.05);
      padding:10px 12px; border-radius:999px; color:var(--text);
      cursor:pointer; user-select:none; font-weight:800; font-size:13px;
      text-decoration:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .pill:hover{transform:translateY(-1px)}
    .pill.primary{border-color:rgba(79,140,255,.5); background:rgba(79,140,255,.18)}
    .pill.good{border-color:rgba(22,163,74,.5); background:rgba(22,163,74,.16)}
    .grid{margin-top:14px; display:grid; gap:12px}
    .stats{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      padding:12px 14px; border:1px solid var(--line); border-radius:var(--r);
      background:rgba(255,255,255,.03);
    }
    .stat{padding:10px 12px; border-radius:14px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10); font-size:13px; color:var(--muted)}
    .stat b{color:var(--text)}
    .list{border:1px solid var(--line); border-radius:var(--r); background:rgba(255,255,255,.03); overflow:hidden}
    .head{display:flex; justify-content:space-between; gap:10px; align-items:center; padding:12px 14px; border-bottom:1px solid var(--line); background:rgba(255,255,255,.04)}
    .head .t{font-weight:900; font-size:14px}
    .small{font-size:12px;color:var(--muted)}
    .items{padding:10px}
    .item{
      border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.045);
      border-radius:var(--r2); padding:12px; margin:10px 0;
      display:grid; gap:10px;
    }
    .item h3{margin:0 0 6px; font-size:15px; font-weight:900}
    .meta{display:flex; flex-wrap:wrap; gap:8px; font-size:12px; color:var(--muted); align-items:center}
    .tag{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.22)}
    .tag.blue{border-color:rgba(79,140,255,.45)}
    .tag.good{border-color:rgba(22,163,74,.45)}
    .tag.warn{border-color:rgba(245,158,11,.45)}
    .loader{padding:14px 16px; border-radius:var(--r); border:1px dashed rgba(255,255,255,.25); color:var(--muted); background:rgba(0,0,0,.18)}
    .empty{padding:22px 16px; text-align:center; color:var(--muted)}
    .body{margin-top:2px; color:rgba(234,240,255,.88); line-height:1.55; white-space:pre-wrap}
    .link{color:#b9d1ff; text-decoration:underline; word-break:break-all; font-weight:900}
    .fileRow{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .fileBtn{
      display:inline-flex; gap:8px; align-items:center;
      padding:9px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      text-decoration:none;
      font-weight:900;
    }
    .preview{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      max-width:360px;
      background: rgba(0,0,0,.18);
    }
    .preview img{width:100%; height:auto; display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1 id="title">××©×™××•×ª ×œ×›×™×ª×”</h1>
          <p class="sub" id="subtitle">×˜×•×¢×Ÿâ€¦</p>
        </div>
      </div>

      <div class="actions">
        <a class="pill primary" href="index.html">ğŸ  ×—×–×¨×” ×œ××ª×¨</a>
        <a class="pill" href="tasks.html">ğŸ“Œ ×œ×›×œ ×”××©×™××•×ª</a>
        <button class="pill good" id="refreshBtn">ğŸ”„ ×¨×¢× ×Ÿ</button>
      </div>
    </header>

    <section class="grid">
      <div class="stats">
        <div class="stat"><b id="count">0</b> ××©×™××•×ª ×‘×›×™×ª×”</div>
        <div class="stat"><b id="classBadge">â€”</b> ×›×™×ª×”</div>
      </div>

      <div class="list">
        <div class="head">
          <div class="t">ğŸ“Œ ××©×™××•×ª</div>
          <div class="small" id="lastUpdated">×œ× × ×˜×¢×Ÿ ×¢×“×™×™×Ÿ</div>
        </div>
        <div class="items" id="items">
          <div class="loader">×˜×•×¢×Ÿ ×Ö¾Firestoreâ€¦</div>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { db } from "./firebase-config.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const CLASS_IDS_BY_GRADE = {
      z: ["z1","z2","z3","z4","z5"],
      h: ["h1","h4","h5","h6"],
      t: ["t1","t2","t3","t4","t5"]
    };

    function classIdToLabel(classId){
      const map = {
        z1:"×–1", z2:"×–2", z3:"×–3", z4:"×–4", z5:"×–5",
        h1:"×—1/7", h4:"×—4/8", h5:"×—5/9", h6:"×—6/10",
        t1:"×˜1", t2:"×˜2", t3:"×˜3", t4:"×˜4", t5:"×˜5"
      };
      const c = String(classId||"").toLowerCase().trim();
      return map[c] || c.toUpperCase();
    }
    function gradeLabel(g){ return g==="z" ? "×–×³" : g==="h" ? "×—×³" : g==="t" ? "×˜×³" : g; }
    function escapeHtml(str){
      return String(str||"")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }
    function normalize(x){ return String(x||"").toLowerCase().trim(); }

    // âœ… ×“×“×œ×™×™×Ÿ ××›×œ ×¤×•×¨××˜ ××¤×©×¨×™
    function taskDueToDate(t){
      const v = t?.dueAt ?? t?.due ?? t?.deadline ?? t?.dueDate ?? t?.date;
      if(!v) return null;

      if (typeof v === "string") {
        const d = new Date(v);
        return Number.isNaN(d.getTime()) ? null : d;
      }
      if (typeof v?.toDate === "function") {
        const d = v.toDate();
        return Number.isNaN(d.getTime()) ? null : d;
      }
      if (typeof v?.seconds === "number") {
        const d = new Date(v.seconds * 1000);
        return Number.isNaN(d.getTime()) ? null : d;
      }
      if (typeof v === "number") {
        const d = new Date(v);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      return null;
    }
    function fmtIL(d){
      return d ? d.toLocaleString("he-IL") : "";
    }
    function looksLikeImage(url, fileType){
      const u = String(url||"").toLowerCase();
      const ft = String(fileType||"").toLowerCase();
      if (ft.startsWith("image/")) return true;
      return /\.(png|jpe?g|webp|gif)$/i.test(u.split("?")[0] || "");
    }

    const itemsEl = document.getElementById("items");
    const refreshBtn = document.getElementById("refreshBtn");
    const countEl = document.getElementById("count");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const titleEl = document.getElementById("title");
    const subtitleEl = document.getElementById("subtitle");
    const classBadgeEl = document.getElementById("classBadge");

    // âœ… ××§×‘×œ ×’× class ×•×’× classId (×›×“×™ ×©×”×œ×™× ×§ ×-class.html ×™×¢×‘×•×“)
    const params = new URLSearchParams(location.search);
    const classId = normalize(params.get("class") || params.get("classId"));
    const grade = classId ? classId[0] : "";

    function isKnownClass(c){
      if(!/^[zht]\d{1,2}$/.test(c)) return false;
      const g = c[0];
      if((CLASS_IDS_BY_GRADE[g]||[]).includes(c)) return true;
      // ×× ×œ× ×‘×¨×©×™××” ×©×œ×š (×›××• h2/h3) ×¢×“×™×™×Ÿ × ××¤×©×¨
      return true;
    }

    function validate(){
      if(!classId || !/^[zht]\d{1,2}$/.test(classId)){
        itemsEl.innerHTML = `<div class="empty">×—×¡×¨ class ×‘×›×ª×•×‘×ª. ×“×•×’××”: <b>tasks-class.html?class=h1</b></div>`;
        subtitleEl.textContent = "×—×¡×¨ class";
        return false;
      }
      if(!isKnownClass(classId)){
        itemsEl.innerHTML = `<div class="empty">class ×œ× ××•×›×¨: <b>${escapeHtml(classId)}</b></div>`;
        subtitleEl.textContent = "×›×™×ª×” ×œ× ××•×›×¨×ª";
        return false;
      }
      titleEl.textContent = `××©×™××•×ª ×œ×›×™×ª×” ${classIdToLabel(classId)}`;
      subtitleEl.textContent = `× ×©×œ×£ ×Ö¾Firestore: tasks/${grade} ×•××¡×•× ×Ÿ ×œÖ¾${classId}`;
      classBadgeEl.textContent = `${gradeLabel(grade)} Â· ${classIdToLabel(classId)}`;
      return true;
    }

    async function load(){
      if(!validate()) return;

      itemsEl.innerHTML = `<div class="loader">×˜×•×¢×Ÿ ×Ö¾tasks/${grade}â€¦</div>`;

      try{
        const snap = await getDoc(doc(db, "tasks", grade));
        const data = snap.exists() ? (snap.data()||{}) : {};
        const items = Array.isArray(data.items) ? data.items : [];
        const list = items
          .filter(t => normalize(t.classId) === classId)
          .map(t => ({ ...t, _dt: taskDueToDate(t) }));

        countEl.textContent = String(list.length);
        lastUpdatedEl.textContent = "×¢×•×“×›×Ÿ: " + new Date().toLocaleString("he-IL");
        render(list);
      }catch(err){
        console.error("load tasks-class failed:", err);
        itemsEl.innerHTML = `
          <div class="empty">
            ×©×’×™××” ×‘×˜×¢×™× ×”.<br>
            ×× ×›×ª×•×‘ <b>permission-denied</b> â€” ×—×¡×¨ rules ×œ- <b>tasks/${grade}</b>.
          </div>
        `;
      }
    }

function toDateAny(x){
  if(!x) return null;
  if(x instanceof Date) return x;
  if(typeof x === "string"){
    const d = new Date(x);
    return Number.isNaN(d.getTime()) ? null : d;
  }
  if(typeof x === "number"){
    const d = new Date(x);
    return Number.isNaN(d.getTime()) ? null : d;
  }
  if(typeof x === "object"){
    // Firestore Timestamp style
    if(typeof x.toDate === "function") return x.toDate();
    if(typeof x.seconds === "number") return new Date(x.seconds * 1000);
  }
  return null;
}

function fmtIL(d){
  if(!d) return "";
  try{ return d.toLocaleString("he-IL"); }catch{ return ""; }
}

function getDueDate(t){
  return toDateAny(t.dueAt) || toDateAny(t.dueDate) || toDateAny(t.deadline) || null;
}

function isImageUrl(url){
  const u = String(url||"").toLowerCase();
  return /\.(png|jpe?g|gif|webp|bmp|svg)(\?.*)?$/.test(u);
}
function fmtDueAt(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  return d.toLocaleString("he-IL");
}

function render(list){
  if(!list.length){
    itemsEl.innerHTML = `<div class="empty">××™×Ÿ ××©×™××•×ª ×œ×›×™×ª×” ×”×–×•.</div>`;
    return;
  }

  list = list.slice().sort((a,b)=>{
    // ×¢×“×™×£ ×œ××™×™×Ÿ ×œ×¤×™ ×“×“×œ×™×™×Ÿ ×× ×™×©, ××—×¨×ª ×œ×¤×™ createdAt
    const ad = new Date(a.dueAt || 0).getTime();
    const bd = new Date(b.dueAt || 0).getTime();
    if(ad && bd) return ad - bd;
    const at = new Date(a.createdAt || 0).getTime();
    const bt = new Date(b.createdAt || 0).getTime();
    return bt - at;
  });

  itemsEl.innerHTML = list.map(t=>{
    const text = String(t.text ?? t.body ?? "").trim();
    const dueTxt = fmtDueAt(t.dueAt);

    const fileUrl = String(t.fileUrl || "").trim();
    const fileName = String(t.fileName || "").trim();
    const linkUrl = String(t.linkUrl || "").trim();
    const finalLink = fileUrl || linkUrl;

    const linkHtml = finalLink
      ? `<div style="margin-top:10px">
          ğŸ“ <a class="link" href="${escapeHtml(finalLink)}" target="_blank" rel="noopener">
            ${escapeHtml(fileUrl ? (fileName || "×¤×ª×— ×§×•×‘×¥") : "×¤×ª×— ×§×™×©×•×¨")}
          </a>
        </div>`
      : "";

    // ×ª×¦×•×’×” ×›×ª××•× ×” ×× ×”×¢×œ×™×ª ×ª××•× ×” ×›×§×•×‘×¥
    const imgHtml = (fileUrl && (String(t.fileType||"").startsWith("image/") || isImageUrl(fileUrl)))
      ? `<div style="margin-top:10px">
           <img src="${escapeHtml(fileUrl)}" alt="×ª××•× ×” ×œ××©×™××”"
                style="max-width:100%;border-radius:14px;border:1px solid rgba(148,163,184,.25);display:block;">
         </div>`
      : "";

    return `
      <div class="item">
        <div>
          <h3>${escapeHtml(t.title || "××©×™××”")}</h3>

          <div class="meta">
            <span class="tag blue"><b>×©×›×‘×”:</b> ${escapeHtml(gradeLabel(grade))}</span>
            <span class="tag"><b>×›×™×ª×”:</b> ${escapeHtml(classIdToLabel(classId))}</span>
            ${t.subject ? `<span class="tag"><b>××§×¦×•×¢:</b> ${escapeHtml(t.subject)}</span>` : ""}
            ${dueTxt ? `<span class="tag" style="border-color:rgba(245,158,11,.35)"><b>×“×“×œ×™×™×Ÿ:</b> ${escapeHtml(dueTxt)}</span>` : ""}
          </div>

          ${text ? `<div style="margin-top:10px; color:rgba(234,240,255,.86); line-height:1.6; white-space:pre-wrap;">${escapeHtml(text)}</div>` : ""}
          ${linkHtml}
          ${imgHtml}
        </div>
      </div>
    `;
  }).join("");
}



    refreshBtn.addEventListener("click", load);
    load();
  </script>
</body>
</html>
