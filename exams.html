<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>××‘×—× ×™× ×œ×¤×™ ×›×™×ª×” â€“ ×™×¢×¨×ª ×”×¢××§</title>

  <link rel="icon" href="logo.png" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ===== ×¢×™×¦×•×‘ ×“×£ ××‘×—× ×™ ×›×™×ª×” ===== */

    body[data-page="class-exams"] {
      background: #0b1120;
      color: #e5f0ff;
    }

    .class-exams-wrapper {
      padding-top: 90px;
    }

    .class-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .class-chip {
      border-radius: 999px;
      padding: 8px 18px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: default;
      white-space: nowrap;
    }

    .class-chip span {
      font-weight: 600;
      font-size: 1.05rem;
    }

    .class-chip-badge {
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 0.7rem;
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.6);
      color: #7dd3fc;
    }

    .back-btn-small {
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.85rem;
      text-decoration: none;
    }

    .class-exams-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 780px;
      margin: 0 auto;
    }

    .exam-card {
      border-radius: 18px;
      padding: 14px 16px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.7);
      display: grid;
      grid-template-columns: 1fr auto;
      column-gap: 16px;
      row-gap: 6px;
      align-items: center;
    }

    .exam-main-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .exam-meta {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .exam-topic {
      grid-column: 1 / -1;
      font-size: 0.9rem;
      color: #e5e7eb;
      margin-top: 4px;
    }

    .exam-date-pill {
      border-radius: 999px;
      padding: 6px 12px;
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.6);
      color: #e0f2fe;
      font-size: 0.8rem;
      text-align: center;
      white-space: nowrap;
    }

    .exam-date-pill span {
      display: block;
    }

    .exam-date-pill .exam-date-main {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .exam-countdown {
      grid-column: 1 / -1;
      font-size: 0.8rem;
      color: #a5b4fc;
      margin-top: 4px;
    }

    .class-empty-msg {
      text-align: center;
      font-size: 0.9rem;
      color: #9ca3af;
      padding: 18px 0;
    }

    @media (max-width: 768px) {
      .class-exams-wrapper {
        padding-top: 80px;
      }

      .class-header-row {
        align-items: flex-start;
        gap: 8px;
      }

      .class-exams-list {
        max-width: 100%;
      }

      .exam-card {
        grid-template-columns: 1fr;
        row-gap: 8px;
      }

      .exam-date-pill {
        justify-self: flex-start;
      }
    }
  </style>
</head>

<body data-page="class-exams">
  <!-- HEADER ×›××• ×‘××ª×¨ ×”×¨××©×™ -->
  <header class="header-main">
    <div class="container">
      <nav class="nav">
        <div class="nav-left">
          <div class="logo-circle">
            <img
              src="https://i.ibb.co/tp4K737Y/Cropped-circle-image-1.png"
              alt="×¡××œ ×‘×™×ª ×”×¡×¤×¨ ×™×¢×¨×ª ×”×¢××§"
              class="logo-img"
              id="logo-img"
            >
          </div>

          <div>
            <div class="school-title-main">
              ×œ×•×— ××‘×—× ×™× ×œ×¤×™ ×›×™×ª×”
            </div>
            <div class="school-title-sub">
              <a href="index.html#home-exams" style="text-decoration:underline;">
                ×—×–×¨×” ×œ××¡×š ×”××‘×—× ×™× ×”×¨××©×™
              </a>
            </div>
          </div>
        </div>

        <div class="nav-right">
          <a href="index.html#about">××•×“×•×ª</a>
          <a href="index.html#home-news">×—×“×©×•×ª</a>
          <a href="index.html#home-exams">××‘×—× ×™×</a>
          <a href="index.html#grades">×”×©×›×‘×•×ª</a>
          <a href="index.html#contact">×™×¦×™×¨×ª ×§×©×¨</a>
          <a href="redirect-edu.html" class="personal-btn">×œ××¨×—×‘ ×”××™×©×™</a>
          <a href="admin.html" class="btn-outline">Admin</a>
        </div>

        <button id="theme-toggle" class="theme-toggle" type="button">
          ğŸŒ™
        </button>

        <button
          class="nav-toggle"
          type="button"
          aria-label="×¤×ª×— ×ª×¤×¨×™×˜"
          aria-expanded="false">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </nav>
    </div>
  </header>

  <main class="class-exams-wrapper">
    <section class="section-light">
      <div class="container">
        <div class="section-header">
          <h1 id="class-title" class="section-title">××‘×—× ×™× ×œ×›×™×ª×”</h1>
          <p id="class-subtitle" class="section-subtitle">
            ×›××Ÿ ×™×•×¤×™×¢×• ×›×œ ×”××‘×—× ×™× ×”×§×¨×•×‘×™× ×©×œ ×”×›×™×ª×” ×©× ×‘×—×¨×”.
          </p>
        </div>

        <div class="class-header-row">
          <div class="class-chip" id="class-chip">
            <div class="class-chip-badge">×›×™×ª×”</div>
            <span id="class-chip-label">?</span>
          </div>

          <a href="index.html#home-exams" class="btn-outline back-btn-small">
            â† ×—×–×¨×” ×œ××‘×—× ×™ ×”×©×›×‘×•×ª
          </a>
        </div>

        <div id="class-exams-list" class="class-exams-list">
          <!-- ×××•×œ× ×“×¨×š JS -->
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p id="footer-text">Â© ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª ×œ×‘×™×ª ×¡×¤×¨ ×™×¢×¨×ª ×”×¢××§</p>
    </div>
  </footer>

  <div id="to-top">â†‘</div>

  <script src="accessibility.js"></script>

  <!-- JS ×œ×“×£ ×”××‘×—× ×™× ×œ×¤×™ ×›×™×ª×” -->
  <script type="module">
    import { db } from "./firebase-config.js";
    import {
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // ===== ×¤×¨××˜×¨×™× ××”-URL =====
    const params = new URLSearchParams(window.location.search);
    const grade = (params.get("grade") || "").toLowerCase();   // z / h / t
    const classId = (params.get("class") || "").toLowerCase(); // z1 / h3 / t5

    const VALID_CLASSES = {
      z: ["z1", "z2", "z3", "z4", "z5"],
      h: ["h1", "h2", "h3", "h4", "h5", "h6"],
      t: ["t1", "t2", "t3", "t4", "t5"]
    };

    const GRADE_LABEL = {
      z: "×©×›×‘×ª ×–'",
      h: "×©×›×‘×ª ×—'",
      t: "×©×›×‘×ª ×˜'"
    };

    function classIdToLabel(id) {
      const map = {
        z1: "×–1", z2: "×–2", z3: "×–3", z4: "×–4", z5: "×–5",
        h1: "×—1", h2: "×—2", h3: "×—3", h4: "×—4", h5: "×—5", h6: "×—6",
        t1: "×˜1", t2: "×˜2", t3: "×˜3", t4: "×˜4", t5: "×˜5"
      };
      return map[id] || id;
    }

    // === ×¤×™×¨×•×© ×ª××¨×™×š + ×©×¢×” ×œ××•×‘×™×™×§×˜ Date (×›××• ×‘-app.js) ===
    function parseExamDateToDateObj(dateStr, timeStr) {
      if (!dateStr) return null;
      let s = String(dateStr).trim();
      if (!s) return null;

      let hh = 8;
      let mm = 0;

      if (timeStr) {
        const tm = String(timeStr).trim().match(/^(\d{1,2}):(\d{2})$/);
        if (tm) {
          hh = Number(tm[1]);
          mm = Number(tm[2]);
        }
      }

      const matchIL = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
      if (matchIL) {
        let day = Number(matchIL[1]);
        let month = Number(matchIL[2]);
        let year = Number(matchIL[3]);
        if (year < 100) year = 2000 + year;
        return new Date(year, month - 1, day, hh, mm);
      }

      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        const [y, m, d] = s.split("-").map(Number);
        return new Date(y, m - 1, d, hh, mm);
      }

      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{1,2}):(\d{2})$/);
      if (m) {
        const y = Number(m[1]);
        const mo = Number(m[2]);
        const d = Number(m[3]);
        const hh2 = Number(m[4]);
        const mm2 = Number(m[5]);
        return new Date(y, mo - 1, d, hh2, mm2);
      }

      const dObj = new Date(s);
      return isNaN(dObj.getTime()) ? null : dObj;
    }

    function formatLocalDate(d) {
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const year = d.getFullYear();
      return `${day}.${month}.${year}`;
    }

    // ===== ×¡×¤×™×¨×” ×œ××—×•×¨ ×‘×“×£ ×›×™×ª×” =====
    let countdownIntervalId = null;

    function updateCountdowns() {
      const els = document.querySelectorAll("[data-exam-timestamp]");
      if (!els.length) return;

      const now = Date.now();

      els.forEach((el) => {
        const ts = Number(el.dataset.examTimestamp);
        if (!ts || Number.isNaN(ts)) {
          el.textContent = "";
          return;
        }

        const diff = ts - now;
        if (diff <= 0) {
          el.textContent = "×”××‘×—×Ÿ ×›×‘×¨ ×”×™×” ××• ××ª×§×™×™× ×¢×›×©×™×•.";
          return;
        }

        const totalSeconds = Math.floor(diff / 1000);
        const days = Math.floor(totalSeconds / (24 * 3600));
        const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        let parts = [];
        if (days > 0) parts.push(`${days} ×™××™×`);
        if (hours > 0) parts.push(`${hours} ×©×¢×•×ª`);
        if (minutes > 0) parts.push(`${minutes} ×“×§×•×ª`);
        parts.push(`${seconds} ×©× ×™×•×ª`);

        el.textContent = `×¡×¤×™×¨×” ×œ××—×•×¨: ${parts.join(" Â· ")}`;
      });
    }

    function startCountdownLoop() {
      if (countdownIntervalId) return;
      countdownIntervalId = setInterval(updateCountdowns, 1000);
    }

    // ===== ×˜×¢×™× ×ª ×”××‘×—× ×™× ×œ×›×™×ª×” =====
    async function loadClassExams() {
      const listEl = document.getElementById("class-exams-list");
      const titleEl = document.getElementById("class-title");
      const subtitleEl = document.getElementById("class-subtitle");
      const chipLabel = document.getElementById("class-chip-label");

      // ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×¤×¨××˜×¨×™×
      const validForGrade = VALID_CLASSES[grade] || [];
      if (!grade || !classId || !validForGrade.includes(classId)) {
        titleEl.textContent = "×©×’×™××” ×‘× ×ª×•× ×™ ×”×›×ª×•×‘×ª";
        subtitleEl.textContent =
          "×”×§×™×©×•×¨ ××™× ×• ×ª×§×™×Ÿ. × ×¡×• ×œ×—×–×•×¨ ×œ××¡×š ×”××‘×—× ×™× ×”×¨××©×™ ×•×œ×‘×—×•×¨ ×©×•×‘ ××ª ×”×›×™×ª×”.";
        listEl.innerHTML =
          '<p class="class-empty-msg">×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”××‘×—× ×™× â€“ ×›×™×ª×” ×œ× ×§×™×™××ª.</p>';
        chipLabel.textContent = "?";
        return;
      }

      const classLabel = classIdToLabel(classId);
      const gradeLabel = GRADE_LABEL[grade] || "";

      titleEl.textContent = `××‘×—× ×™× Â· ×›×™×ª×” ${classLabel}`;
      subtitleEl.textContent = `×›×œ ×”××‘×—× ×™× ×”×§×¨×•×‘×™× ×©×œ ×›×™×ª×” ${classLabel} (${gradeLabel}).`;
      chipLabel.textContent = classLabel;

      try {
        // ×©×™××™ ×œ×‘: ×›××Ÿ ×”××¡××š ×”×•× ×œ×¤×™ ×›×™×ª×”! exams/z1, exams/h3 ×•×›×•'
        const refDoc = doc(db, "exams", classId);
        const snap = await getDoc(refDoc);
        const data = snap.exists() ? snap.data() : { items: [] };
        const allExams = data.items || [];

        const withDates = allExams
          .map((ex) => ({
            ...ex,
            _dateObj: parseExamDateToDateObj(ex.date, ex.time)
          }))
          .filter((ex) => ex._dateObj);

        if (!withDates.length) {
          listEl.innerHTML =
            '<p class="class-empty-msg">×›×¨×’×¢ ××™×Ÿ ××‘×—× ×™× ×¨×©×•××™× ×œ×›×™×ª×” ×–×•.</p>';
          return;
        }

        withDates.sort((a, b) => a._dateObj - b._dateObj);

        listEl.innerHTML = "";

        withDates.forEach((ex) => {
          const d = ex._dateObj;
          const day = String(d.getDate()).padStart(2, "0");
          const month = String(d.getMonth() + 1).padStart(2, "0");
          const yearShort = String(d.getFullYear()).slice(-2);
          const timeText = ex.time ? ex.time : "×©×¢×” ×œ× ×¦×•×™× ×”";
          const ts = d.getTime();

          const card = document.createElement("div");
          card.className = "exam-card";
          card.innerHTML = `
            <div>
              <div class="exam-main-title">${ex.subject || "××‘×—×Ÿ"}</div>
              <div class="exam-meta">
                ×ª××¨×™×š: ${ex.date || formatLocalDate(d)} Â· ×©×¢×”: ${timeText}
              </div>
            </div>
            <div class="exam-date-pill">
              <span class="exam-date-main">${day}/${month}</span>
              <span>${yearShort}</span>
            </div>
            <div class="exam-topic">
              ${ex.topic || "×œ×œ× ×ª×™××•×¨ ××¤×•×¨×˜."}
            </div>
            <div class="exam-countdown" data-exam-timestamp="${ts}"></div>
          `;
          listEl.appendChild(card);
        });

        updateCountdowns();
        startCountdownLoop();
      } catch (err) {
        console.error(err);
        listEl.innerHTML =
          '<p class="class-empty-msg">××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”××‘×—× ×™×. × ×¡×• ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.</p>';
      }
    }

    loadClassExams();
  </script>

  <!-- app.js ×‘×©×‘×™×œ ××¦×‘ ×›×”×” / ×ª×¤×¨×™×˜ ××•×‘×™×™×œ ×•×›×•' -->
  <script type="module" src="app.js"></script>
</body>
</html>
