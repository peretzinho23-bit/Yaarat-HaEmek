<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>הוסף עדכון חי</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f6f7fb}
    .wrap{max-width:760px;margin:24px auto;padding:16px}

    /* header */
    .topbar{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .logoLink{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .logoImg{
      width:44px;height:44px;border-radius:12px;object-fit:cover;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 8px 18px rgba(0,0,0,.08);
      background:#fff;
    }
    .brand{font-weight:900}
    .brand small{display:block;font-weight:800;opacity:.6;margin-top:2px}

    .card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:16px}
    h1{margin:0 0 12px;font-size:20px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    label{font-weight:800;font-size:13px;opacity:.85}
    input,select,textarea{border:1px solid rgba(0,0,0,.14);border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
    textarea{min-height:140px;resize:vertical;line-height:1.4}
    .actions{display:flex;gap:10px;justify-content:flex-start;margin-top:14px;flex-wrap:wrap}
    button{border:1px solid rgba(0,0,0,.12);background:#fff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    button.primary{background:rgba(220,38,38,.12);border-color:rgba(220,38,38,.25)}
    .muted{opacity:.75;font-size:12px;font-weight:700}
    .danger{color:#b91c1c;font-weight:800}
    .ok{color:#166534;font-weight:800}
    .hide{display:none}
    @media (max-width:700px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- ✅ Logo (clickable) -->
    <div class="topbar">
      <a class="logoLink" href="/" title="חזרה לדף הבית">
        <img class="logoImg" src="/favicon-192x192.png" alt="לוגו" onerror="this.style.display='none'">
        <div class="brand">
          יערת העמק
          <small>הוספת עדכון חי</small>
        </div>
      </a>
    </div>

    <div class="card">
      <h1>הוסף עדכון חי</h1>
      <div id="status" class="muted">בודק הרשאות...</div>

      <div id="loginHint" class="hide actions" style="margin-top:10px">
        <button id="goHome">חזרה לאתר</button>
        <button id="goLogin" class="primary">התחברות</button>
      </div>

      <div id="formArea" class="hide">
        <div class="row">
          <div class="field">
            <label>כותרת</label>
            <input id="title" maxlength="120" placeholder="למשל: שינוי במערכת / הודעה חשובה" />
          </div>

          <div class="field">
            <label>למי לשלוח</label>
            <select id="audienceType">
              <option value="all">כולם</option>
              <option value="grade">שכבה</option>
              <option value="class">כיתה</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>שכבה (רק אם בחרת שכבה)</label>
            <input id="audienceGrade" placeholder="למשל: ז / ח / ט" />
          </div>

          <div class="field">
            <label>כיתה (רק אם בחרת כיתה)</label>
            <input id="audienceClass" placeholder="למשל: ח2 / ט1 / ז3" />
          </div>
        </div>

        <div class="field">
          <label>תוכן העדכון</label>
          <textarea id="text" maxlength="2500" placeholder="כתוב את ההודעה כאן..."></textarea>
          <div class="muted">העדכון יופיע בלייב ל-24 שעות, ואז יישאר רק בארכיון.</div>
        </div>

        <div class="field">
          <label>תמונה (אופציונלי)</label>
          <input id="image" type="file" accept="image/*" />
          <div class="muted">עדיף תמונה אחת.</div>
        </div>

        <div class="actions">
          <button id="publish" class="primary">פרסם עדכון</button>
          <button id="back">חזרה</button>
          <span id="msg" class="muted"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Firebase v11 module code -->
 <!-- שים את זה במקום כל בלוק ה-script הישן -->
<script type="module">
  import { db, auth, storage } from "./firebase-config.js";

  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import {
    doc, getDoc, collection, writeBatch, serverTimestamp, Timestamp
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  import {
    ref as sRef, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

  const $ = (id) => document.getElementById(id);

  function setStatus(html, cls="muted"){
    const s = $("status");
    s.className = cls;
    s.innerHTML = html;
  }

  async function isTeacherUser(user){
    try{
      const roleSnap = await getDoc(doc(db, "adminUsers", user.uid));
      const role = roleSnap.exists() ? String(roleSnap.data().role || "").toLowerCase() : "";
      const staffRoles = ["teacherpanel","teacher","gradelead","counselor","principal","dev","admin"];
      if (staffRoles.includes(role)) return true;

      const email = user.email ? String(user.email).toLowerCase() : "";
      if (!email) return false;

      const allowSnap = await getDoc(doc(db, "teacherAllow", email));
      return allowSnap.exists() && allowSnap.data().active === true;
    }catch{
      return false;
    }
  }

  function getAudience(){
    const type = $("audienceType").value;
    const grade = $("audienceGrade").value.trim();
    const cls = $("audienceClass").value.trim();

    if(type === "grade" && !grade) throw new Error("בחרת שכבה אבל לא מילאת שכבה.");
    if(type === "class" && !cls) throw new Error("בחרת כיתה אבל לא מילאת כיתה.");

    return { type, grade: grade || null, classId: cls || null };
  }

  async function uploadImageIfAny(postId){
    const file = $("image").files?.[0];
    if(!file) return [];

    const path = `updates/${postId}/${Date.now()}_${file.name}`;
    const r = sRef(storage, path);

    await uploadBytes(r, file);
    const url = await getDownloadURL(r);
    return [url];
  }

  async function publish(){
    $("publish").disabled = true;
    $("msg").textContent = "מפרסם...";

    try{
      const user = auth.currentUser;
      if(!user) throw new Error("אתה לא מחובר.");

      const ok = await isTeacherUser(user);
      if(!ok) throw new Error("אין לך הרשאה לפרסם עדכון.");

      const title = $("title").value.trim();
      const text = $("text").value.trim();
      if(!text) throw new Error("חייב תוכן לעדכון.");

      const audience = getAudience();

      const postId = doc(collection(db, "liveUpdates")).id;
      const imageUrls = await uploadImageIfAny(postId);

      const now = Date.now();
      const expiresAt = Timestamp.fromDate(new Date(now + 24*60*60*1000));

      const base = {
        title: title || "",
        text,
        audience,
        imageUrls,              // ✅ array
        authorUid: user.uid,
        authorName: user.email || user.displayName || "צוות בית הספר",
        authorPhoto: user.photoURL || "",
        createdAt: serverTimestamp(),
        expiresAt,
        likesCount: 0,
        viewsCount: 0
      };

      const liveRef = doc(db, "liveUpdates", postId);
      const archRef = doc(db, "updateArchive", postId);

      const batch = writeBatch(db);
      batch.set(liveRef, base);
      batch.set(archRef, { ...base, archivedAt: serverTimestamp() });
      await batch.commit();

      $("msg").textContent = "✅ פורסם!";
      setStatus("פורסם בהצלחה. חוזר לדף הראשי...", "ok");
      setTimeout(() => (location.href = "/"), 800);
    }catch(e){
      $("msg").textContent = "";
      setStatus(`שגיאה: ${e?.message || e}`, "danger");
      $("publish").disabled = false;
    }
  }

  $("publish").addEventListener("click", publish);
  $("back").addEventListener("click", () => history.back());

  onAuthStateChanged(auth, async (user) => {
    if(!user){
      setStatus("אתה לא מחובר. תתחבר דרך האתר ואז תחזור לכאן.", "danger");
      return;
    }
    const ok = await isTeacherUser(user);
    if(!ok){
      setStatus("אין לך הרשאה לפרסם עדכונים.", "danger");
      return;
    }
    setStatus("מחובר ומורשה לפרסום ✅", "ok");
    $("formArea").classList.remove("hide");
  });
</script>
