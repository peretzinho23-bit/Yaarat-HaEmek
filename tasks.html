<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>×›×œ ×”××©×™××•×ª Â· ×™×¢×¨×ª ×”×¢××§</title>

  <style>
    :root{
      --bgA:#070a12;
      --bgB:#0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.04);
      --line: rgba(148,163,184,.35);
      --text:#eaf0ff;
      --muted: rgba(234,240,255,.72);
      --shadow: 0 18px 45px rgba(15,23,42,0.18);
      --r: 18px;
      --r2: 14px;
      --w: 1100px;

      --accent: #3b82f6;
      --accent2:#38bdf8;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --chipbg: rgba(255,255,255,.08);
      --inputbg: rgba(0,0,0,.20);
    }

    html[data-theme="light"]{
      --bgA:#eef2ff;
      --bgB:#f8fafc;
      --card: rgba(255,255,255,.85);
      --card2: rgba(255,255,255,.70);
      --line: rgba(15,23,42,.12);
      --text:#0f172a;
      --muted: rgba(15,23,42,.65);
      --shadow: 0 18px 45px rgba(15,23,42,0.12);

      --chipbg: rgba(15,23,42,.05);
      --inputbg: rgba(255,255,255,.88);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      min-height:100svh;
      background:
        radial-gradient(1200px 600px at 85% -10%, rgba(59,130,246,.22), transparent 55%),
        radial-gradient(900px 500px at 15% 0%, rgba(22,163,74,.14), transparent 55%),
        linear-gradient(180deg,var(--bgA),var(--bgB));
    }

    .container{max-width:var(--w); margin:0 auto; padding:0 18px}
    .page-wrap{max-width:var(--w); margin:0 auto; padding:18px 18px 70px}

    .header-main{position:sticky; top:0; z-index:999; padding:10px 0}
    .nav{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding: 12px 14px;
      border-radius: 22px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      position:relative;
    }

    .nav-side{display:flex; gap:10px; align-items:center; flex:1}
    .nav-right-links{justify-content:flex-start}
    .nav-left-links{justify-content:flex-end}

    .nav-side a{
      padding:8px 14px;border-radius:999px;
      background: rgba(255,255,255,0.92);
      border:1px solid rgba(148,163,184,0.55);
      color:#0f172a;
      transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
      box-shadow:0 8px 20px rgba(15,23,42,0.08);
      font-size:.92rem;text-decoration:none;white-space:nowrap;
    }
    html[data-theme="dark"] .nav-side a{
      background: rgba(15,23,42,0.55);
      color: #e5e7eb;
      border-color: rgba(148,163,184,0.25);
      box-shadow: 0 10px 25px rgba(0,0,0,0.28);
    }
    .nav-side a:hover{transform:translateY(-1px); background:#eff6ff}
    html[data-theme="dark"] .nav-side a:hover{background: rgba(2,6,23,0.55)}

    .logo-circle{
      width:62px;height:62px;border-radius:999px;overflow:hidden;
      border:2px solid rgba(59,130,246,0.35);
      background: rgba(255,255,255,.9);
      box-shadow:0 10px 25px rgba(15,23,42,0.12);
      display:flex;align-items:center;justify-content:center;
    }
    html[data-theme="dark"] .logo-circle{
      background: rgba(15,23,42,0.55);
      border-color: rgba(56,189,248,0.35);
    }
    .logo-img{width:100%;height:100%;object-fit:cover;display:block}

    .theme-toggle-btn{
      all:unset;box-sizing:border-box;
      width:44px;height:44px;border-radius:50%;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;
      border:1px solid rgba(148,163,184,0.6);
      background: rgba(255,255,255,0.92);
      box-shadow:0 8px 20px rgba(15,23,42,0.08);
      font-size:1.35rem;
      position:absolute;
      right:12px;
      top:50%;
      transform:translateY(-50%);
      z-index:50;
    }
    html[data-theme="dark"] .theme-toggle-btn{
      background: rgba(15,23,42,0.9);
      color:#f9fafb;
      border-color: rgba(148,163,184,0.25);
      box-shadow: 0 10px 25px rgba(0,0,0,0.28);
    }

    .nav-toggle{display:none}
    .nav-mobile{display:none}

    @media (max-width: 900px){
      .nav-right-links,.nav-left-links{display:none !important}
      .nav{justify-content:center !important; min-height:74px}

      .nav-toggle{
        display:flex !important;
        position:absolute !important;
        left:12px !important;
        top:50% !important;
        transform:translateY(-50%) !important;
        flex-direction:column;gap:4px;
        background:none;border:none;cursor:pointer;z-index:9999;
      }
      .nav-toggle span{width:22px;height:2px;background:#0f172a}
      html[data-theme="dark"] .nav-toggle span{background:#e5e7eb}

      #nav-mobile{
        display:none;
        position:absolute;
        top:calc(100% + 10px);
        left:12px;
        width:min(260px, calc(100% - 24px));
        background: rgba(255,255,255,0.98);
        border:1px solid rgba(148,163,184,0.45);
        border-radius:18px;
        padding:10px;
        box-shadow: var(--shadow);
        z-index:9999;
      }
      html[data-theme="dark"] #nav-mobile{
        background: rgba(15,23,42,0.95);
        border-color: rgba(148,163,184,0.25);
      }
      #nav-mobile.open{display:block !important}

      #nav-mobile a{
        display:block;
        padding:10px 12px;
        border-radius:12px;
        margin:6px 0;
        background: rgba(255,255,255,0.9);
        border:1px solid rgba(148,163,184,0.45);
        color:#0f172a;
        text-decoration:none;
        font-weight:800;
      }
      html[data-theme="dark"] #nav-mobile a{
        background: rgba(2,6,23,0.55);
        border-color: rgba(148,163,184,0.20);
        color:#e5e7eb;
      }
    }

    .card{
      border:1px solid var(--line);
      background: var(--card);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }

    .hero{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap;
    }
    .hero h1{margin:0; font-size:1.25rem; font-weight:1000; letter-spacing:.2px}
    .hero p{margin:6px 0 0; color:var(--muted); font-weight:700}
    .hero-right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--chipbg);
      font-weight:900;
      color: var(--text);
      white-space:nowrap;
    }
    .chip.good{border-color: rgba(22,163,74,.35)}
    .chip.blue{border-color: rgba(59,130,246,.35)}

    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:999px;
      border:1px solid var(--line);
      background: var(--chipbg);
      color: var(--text);
      cursor:pointer;
      font-weight:1000;
      text-decoration:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{border-color: rgba(59,130,246,.40); background: rgba(59,130,246,.14)}
    .btn.good{border-color: rgba(22,163,74,.40); background: rgba(22,163,74,.14)}
    .btn.ghost{background: var(--chipbg)}
    .btn.danger{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12)}

    .grid{display:grid; gap:12px; margin-top:12px}
    .filters{
      display:grid;
      grid-template-columns: 1.3fr .6fr .7fr .7fr;
      gap:10px;
    }
    @media (max-width: 940px){ .filters{grid-template-columns: 1fr 1fr} }
    @media (max-width: 540px){ .filters{grid-template-columns: 1fr} }

    label{display:block; font-size:.85rem; color:var(--muted); margin:0 2px 6px; font-weight:900}
    input,select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: var(--inputbg);
      color: var(--text);
      outline:none;
      font-weight:800;
    }
    input::placeholder{color: rgba(148,163,184,.75)}
    html[data-theme="light"] input::placeholder{color: rgba(15,23,42,.45)}

    .stats{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
    }
    .stats-left{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .stat{
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: var(--card2);
      font-weight:900;
      color: var(--muted);
    }
    .stat b{color: var(--text)}
    .live{
      font-weight:1000;
      color: var(--muted);
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(22,163,74,.95);
      box-shadow: 0 0 0 6px rgba(22,163,74,.16);
    }

    .list-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px 14px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius: calc(var(--r) - 2px) calc(var(--r) - 2px) 0 0;
    }
    .list-title{font-weight:1000}
    .items{padding:12px}

    .loader{
      padding:14px 16px;
      border-radius: 16px;
      border:1px dashed rgba(148,163,184,.45);
      background: rgba(0,0,0,.12);
      color: var(--muted);
      font-weight:900;
    }
    html[data-theme="light"] .loader{background: rgba(15,23,42,.04)}

    .empty{
      padding:20px 14px;
      text-align:center;
      color: var(--muted);
      font-weight:900;
    }

    .task{
      border:1px solid var(--line);
      background: var(--card2);
      border-radius: 18px;
      padding:12px;
      margin:10px 0;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      overflow:hidden;
    }
    .task:hover{
      transform: translateY(-1px);
      border-color: rgba(59,130,246,.25);
      box-shadow: 0 16px 40px rgba(0,0,0,.18);
    }

    .task-top{display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap}
    .task-title{font-weight:1000; font-size:1.02rem; margin:0}
    .task-meta{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--chipbg);
      font-weight:1000;
      color: var(--text);
      font-size:.9rem;
      white-space:nowrap;
    }
    .tag.blue{border-color: rgba(59,130,246,.35)}
    .tag.good{border-color: rgba(22,163,74,.35)}
    .tag.warn{border-color: rgba(245,158,11,.35)}

    .task-body{
      margin-top:10px;
      color: rgba(234,240,255,.92);
      line-height:1.6;
      white-space:pre-wrap;
      font-weight:700;
    }
    html[data-theme="light"] .task-body{color:#0f172a}

    .task-body a{
      color:#b9d1ff;
      font-weight:1000;
      text-decoration: underline;
      word-break: break-all;
    }
    html[data-theme="light"] .task-body a{color:#1d4ed8}

    .task-link{
      margin-top:10px;
      display:inline-flex; gap:8px; align-items:center;
      color: #b9d1ff;
      font-weight:1000;
      text-decoration: underline;
      word-break: break-all;
    }
    html[data-theme="light"] .task-link{color:#1d4ed8}

    /* âœ… ×ª××•× ×•×ª ××©×™××” */
    .task-imgs{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .task-imgs img{
      width:min(240px, 100%);
      max-width:240px;
      aspect-ratio: 4 / 3;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.25);
      box-shadow: 0 14px 34px rgba(0,0,0,.18);
    }

    .mini-muted{color:var(--muted); font-weight:900; font-size:.92rem}
  </style>
</head>

<body>
  <header class="header-main">
    <div class="container">
      <nav class="nav" aria-label="× ×™×•×•×˜ ×¨××©×™">

        <div class="nav-side nav-right-links">
          <a href="index.html">â† ×“×£ ×”×‘×™×ª</a>
          <a id="backToClassTop" href="class.html">×“×£ ×›×™×ª×”</a>
          <a href="#listCard">××©×™××•×ª</a>
        </div>

        <div class="nav-center">
          <a href="index.html" class="logo-circle" aria-label="×“×£ ×”×‘×™×ª">
            <img
              src="https://i.ibb.co/tp4K737Y/Cropped-circle-image-1.png"
              alt="×¡××œ ×™×¢×¨×ª ×”×¢××§"
              class="logo-img"
            />
          </a>
        </div>

        <div class="nav-side nav-left-links">
          <a href="#filtersCard">×¡×™× ×•×Ÿ</a>
          <a href="#listCard">×¨×©×™××”</a>
          <a id="ctxChipLink" href="#filtersCard">×›×™×ª×”</a>
        </div>

        <button id="theme-toggle" class="theme-toggle-btn" type="button" aria-label="××¦×‘ ×›×”×”/×‘×”×™×¨">ğŸŒ™</button>

        <button class="nav-toggle" id="nav-toggle" type="button" aria-label="×¤×ª×— ×ª×¤×¨×™×˜" aria-expanded="false" aria-controls="nav-mobile">
          <span></span><span></span><span></span>
        </button>

        <div class="nav-mobile" id="nav-mobile" aria-hidden="true">
          <a href="index.html">â† ×“×£ ×”×‘×™×ª</a>
          <a id="backToClassMobile" href="class.html">×“×£ ×›×™×ª×”</a>
          <a href="#filtersCard">×¡×™× ×•×Ÿ</a>
          <a href="#listCard">××©×™××•×ª</a>
        </div>

      </nav>
    </div>
  </header>

  <main class="page-wrap">
    <section class="card" id="filtersCard">
      <div class="hero">
        <div>
          <h1 id="heroTitle">×›×œ ×”××©×™××•×ª</h1>
          <p id="heroSub">××¨×•×›×– ××›×œ ×”×©×›×‘×•×ª Â· ×›×•×œ×œ ×¡×™× ×•×Ÿ ×—×›× ×œ×¤×™ ×›×™×ª×”</p>
        </div>

        <div class="hero-right">
          <span class="chip blue" id="ctxChip" style="display:none;">ğŸ” ×›×™×ª×”: â€”</span>
          <span class="chip good" id="fromClassChip" style="display:none;">â†©ï¸ ×”×’×¢×ª ××“×£ ×›×™×ª×”</span>

          <a class="btn primary" href="index.html">ğŸ  ××ª×¨</a>
          <a class="btn ghost" id="backToClassBtn" href="class.html" style="display:none;">â†©ï¸ ×—×–×¨×” ×œ×›×™×ª×”</a>
          <button class="btn ghost" id="clearBtn" type="button">ğŸ§¼ × ×§×”</button>
          <button class="btn good" id="refreshBtn" type="button">ğŸ”„ ×¨×¢× ×Ÿ</button>
        </div>
      </div>

      <div class="grid" style="margin-top:14px;">
        <div class="filters">
          <div>
            <label for="q">×—×™×¤×•×©</label>
            <input id="q" placeholder="×—×¤×© ×œ×¤×™ ×›×•×ª×¨×ª / ×ª×•×›×Ÿ / ×›×™×ª×”â€¦" />
          </div>

          <div>
            <label for="grade">×©×›×‘×”</label>
            <select id="grade">
              <option value="all">×”×›×œ</option>
              <option value="z">×–×³</option>
              <option value="h">×—×³</option>
              <option value="t">×˜×³</option>
            </select>
          </div>

          <div>
            <label for="classId">×›×™×ª×”</label>
            <select id="classId">
              <option value="all">×”×›×œ</option>
            </select>
          </div>

          <div>
            <label for="sort">××™×•×Ÿ</label>
            <select id="sort">
              <option value="newFirst">×—×“×© ×§×•×“×</option>
              <option value="oldFirst">×™×©×Ÿ ×§×•×“×</option>
              <option value="titleAsc">×›×•×ª×¨×ª ×-×ª</option>
              <option value="dueSoon">×“×“×œ×™×™×Ÿ ×§×¨×•×‘</option>
            </select>
          </div>
        </div>

        <div class="stats">
          <div class="stats-left">
            <div class="stat"><b id="countAll">0</b> ××©×™××•×ª</div>
            <div class="stat"><b id="countFiltered">0</b> ××—×¨×™ ×¡×™× ×•×Ÿ</div>
          </div>

          <div class="live">
            <span class="dot"></span>
            <span id="liveClock">×©×¢×”: â€”</span>
          </div>
        </div>
      </div>
    </section>

    <section class="card" id="listCard" style="margin-top:12px; padding:0;">
      <div class="list-head">
        <div class="list-title">ğŸ“Œ ××©×™××•×ª</div>
        <div class="mini-muted" id="lastFetch">×˜×¢×™× ×” ××—×¨×•× ×”: â€”</div>
      </div>

      <div class="items" id="items">
        <div class="loader">×˜×•×¢×Ÿ ×Ö¾Firestoreâ€¦</div>
      </div>
    </section>
  </main>

  <script>
    (function () {
      const btn = document.getElementById("theme-toggle");
      if (!btn) return;

      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        btn.textContent = theme === "dark" ? "ğŸŒ™" : "â˜€ï¸";
        try { localStorage.setItem("theme", theme); } catch {}
      }

      let saved = "dark";
      try { saved = localStorage.getItem("theme") || "dark"; } catch {}
      applyTheme(saved);

      btn.addEventListener("click", () => {
        const cur = document.documentElement.getAttribute("data-theme") || "dark";
        applyTheme(cur === "dark" ? "light" : "dark");
      });
    })();

    (function () {
      const btn = document.getElementById("nav-toggle");
      const menu = document.getElementById("nav-mobile");
      if (!btn || !menu) return;

      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = menu.classList.toggle("open");
        btn.setAttribute("aria-expanded", String(isOpen));
        menu.setAttribute("aria-hidden", String(!isOpen));
      });

      menu.querySelectorAll("a").forEach((a) => {
        a.addEventListener("click", () => {
          menu.classList.remove("open");
          btn.setAttribute("aria-expanded", "false");
          menu.setAttribute("aria-hidden", "true");
        });
      });

      document.addEventListener("click", (e) => {
        if (menu.contains(e.target) || btn.contains(e.target)) return;
        menu.classList.remove("open");
        btn.setAttribute("aria-expanded", "false");
        menu.setAttribute("aria-hidden", "true");
      });
    })();
  </script>

  <script type="module">
    import { db } from "./firebase-config.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const GRADES = ["z","h","t"];
    const CLASS_IDS_BY_GRADE = {
      z: ["z1","z2","z3","z4","z5"],
      h: ["h1","h4","h5","h6"],
      t: ["t1","t2","t3","t4","t5"]
    };

    function classIdToLabel(classId){
      const map = {
        z1:"×–1", z2:"×–2", z3:"×–3", z4:"×–4", z5:"×–5",
        h1:"×—1/7", h4:"×—4/8", h5:"×—5/9", h6:"×—6/10",
        t1:"×˜1", t2:"×˜2", t3:"×˜3", t4:"×˜4", t5:"×˜5"
      };
      return map[String(classId||"").toLowerCase()] || String(classId||"");
    }

    function gradeFromClassId(classId){
      const c = String(classId||"").toLowerCase().trim();
      if(!c) return "";
      if(c.startsWith("z")) return "z";
      if(c.startsWith("h")) return "h";
      if(c.startsWith("t")) return "t";
      return "";
    }

    function gradeLabel(g){
      return g==="z" ? "×–×³" : g==="h" ? "×—×³" : g==="t" ? "×˜×³" : g;
    }

    function escapeHtml(str){
      return String(str||"")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    // âœ… ×œ×™× ×§×™× ×§×œ×™×§×™× ×‘×ª×•×š ×˜×§×¡×˜ (××—×¨×™ escape)
    function linkifySafe(text){
      const safe = escapeHtml(text || "");
      return safe.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
      );
    }

    function normalize(x){ return String(x||"").toLowerCase().trim(); }

    // âœ… ×ª××•× ×•×ª ××›×œ ×”×©×“×•×ª ×”××¤×©×¨×™×™× (×ª××™××•×ª)
    function extractImages(t){
      const imgs = [];
      if (Array.isArray(t.imageUrls)) imgs.push(...t.imageUrls);
      if (t.imageUrl) imgs.push(t.imageUrl);
      if (t.imageUrl2) imgs.push(t.imageUrl2);

      if (Array.isArray(t.images)) imgs.push(...t.images);
      if (t.image) imgs.push(t.image);

      return [...new Set(imgs.map(x=>String(x||"").trim()).filter(Boolean))].slice(0, 3);
    }

    // âœ… date parser ××—×“ ×œ×›×œ ×”×©×“×•×ª (ISO / Timestamp / seconds / ms)
    function toDateAny(v){
      if(!v) return null;

      // Firestore Timestamp object (has toDate)
      if (typeof v?.toDate === "function") {
        const d = v.toDate();
        return Number.isNaN(d.getTime()) ? null : d;
      }

      // raw timestamp {seconds}
      if (typeof v?.seconds === "number") {
        const d = new Date(v.seconds * 1000);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      // ms number
      if (typeof v === "number") {
        const d = new Date(v);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      // string (ISO or anything Date can parse)
      if (typeof v === "string") {
        const d = new Date(v);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      return null;
    }

    // âœ… ×“×“×œ×™×™×Ÿ: ×ª×•×¤×¡ dueAt / due / deadline + fallback dueDate+dueTime
    function getDueDate(t){
      const raw = t?.dueAt ?? t?.due ?? t?.deadline;
      const d = toDateAny(raw);
      if (d) return d;

      // fallback: dueDate + dueTime
      const dd = t?.dueDate || t?.date;
      const tm = t?.dueTime || t?.time;
      if(!dd) return null;

      // dd can be "DD/MM/YYYY"
      const m = String(dd).trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
      if(!m) return toDateAny(dd);

      let day = Number(m[1]), mo = Number(m[2]), y = Number(m[3]);
      if (y < 100) y = 2000 + y;
      const dt = new Date(y, mo - 1, day);

      if (typeof tm === "string" && /^\d{1,2}:\d{2}$/.test(tm.trim())) {
        const [hh, mm] = tm.trim().split(":").map(Number);
        dt.setHours(hh, mm, 0, 0);
      } else {
        dt.setHours(23, 59, 0, 0);
      }

      return Number.isNaN(dt.getTime()) ? null : dt;
    }

    function fmtIL(d){
      return d ? d.toLocaleString("he-IL") : "";
    }

    // âœ… ×—×©×•×‘: ×œ×—×¤×© ×’× ×‘-text + subject + dueAt
    function blob(t){
      return [
        t.title,
        t.text,
        t.body,
        t.subject,
        t.classId,
        classIdToLabel(t.classId),
        t.grade,
        t.dueAt,
        t.due,
        t.deadline
      ].map(v=>String(v||"")).join(" ").toLowerCase();
    }

    const itemsEl = document.getElementById("items");
    const qEl = document.getElementById("q");
    const gradeEl = document.getElementById("grade");
    const classEl = document.getElementById("classId");
    const sortEl = document.getElementById("sort");
    const refreshBtn = document.getElementById("refreshBtn");
    const clearBtn = document.getElementById("clearBtn");

    const countAllEl = document.getElementById("countAll");
    const countFilteredEl = document.getElementById("countFiltered");
    const lastFetchEl = document.getElementById("lastFetch");
    const liveClockEl = document.getElementById("liveClock");

    const ctxChip = document.getElementById("ctxChip");
    const fromClassChip = document.getElementById("fromClassChip");
    const backToClassBtn = document.getElementById("backToClassBtn");
    const backToClassTop = document.getElementById("backToClassTop");
    const backToClassMobile = document.getElementById("backToClassMobile");
    const heroTitle = document.getElementById("heroTitle");
    const heroSub = document.getElementById("heroSub");

    let ALL = [];
    let lastFetchedAt = null;

    function refreshClassDropdown(){
      const g = gradeEl.value;
      const cur = classEl.value;

      const opts = [{v:"all", t:"×”×›×œ"}];
      if(g === "all"){
        const all = Object.values(CLASS_IDS_BY_GRADE).flat();
        for(const id of all) opts.push({v:id, t: classIdToLabel(id)});
      }else{
        for(const id of (CLASS_IDS_BY_GRADE[g]||[])) opts.push({v:id, t: classIdToLabel(id)});
      }

      classEl.innerHTML = opts.map(o=>`<option value="${o.v}">${o.t}</option>`).join("");
      classEl.value = opts.some(o=>o.v===cur) ? cur : "all";
    }

    function pickInitialContext(){
      const params = new URLSearchParams(location.search);
      let classId = normalize(params.get("class") || params.get("classId"));
      let grade = normalize(params.get("grade"));

      const ref = normalize(document.referrer || "");
      const hasRef = !!ref;

      if(!classId && ref){
        const m = ref.match(/(?:\?|&)class=([zht]\d{1,2})\b/i) || ref.match(/\b([zht]\d{1,2})\b/i);
        if(m) classId = normalize(m[1]);
      }

      if(!classId){
        try{ classId = normalize(localStorage.getItem("lastClassId")); }catch{}
      }

      if(classId && !grade) grade = gradeFromClassId(classId);

      if(classId && !/^[zht]\d{1,2}$/.test(classId)){
        classId = "";
        grade = "";
      }

      return { classId, grade, hasRef };
    }

    function applyContextUI(ctx){
      if(ctx.classId){
        ctxChip.style.display = "inline-flex";
        ctxChip.textContent = `ğŸ” ${gradeLabel(ctx.grade)} Â· ${classIdToLabel(ctx.classId)}`;

        heroTitle.textContent = `××©×™××•×ª ×œ×›×™×ª×” ${classIdToLabel(ctx.classId)}`;
        heroSub.textContent = "×”×“×£ ×¡×™× ×Ÿ ××•×˜×•××˜×™×ª ×œ×¤×™ ×”×›×™×ª×” ×©×œ×š.";

        fromClassChip.style.display = ctx.hasRef ? "inline-flex" : "none";

        backToClassBtn.style.display = "inline-flex";
        backToClassBtn.href = `class.html?class=${encodeURIComponent(ctx.classId)}`;

        backToClassTop.href = `class.html?class=${encodeURIComponent(ctx.classId)}`;
        backToClassMobile.href = `class.html?class=${encodeURIComponent(ctx.classId)}`;
      }else{
        ctxChip.style.display = "none";
        fromClassChip.style.display = "none";
        backToClassBtn.style.display = "none";

        heroTitle.textContent = "×›×œ ×”××©×™××•×ª";
        heroSub.textContent = "××¨×•×›×– ××›×œ ×”×©×›×‘×•×ª Â· ×›×•×œ×œ ×¡×™× ×•×Ÿ ×—×›× ×œ×¤×™ ×›×™×ª×”";

        backToClassTop.href = "class.html";
        backToClassMobile.href = "class.html";
      }
    }

    function applyInitialContext(){
      const ctx = pickInitialContext();

      if(ctx.grade) gradeEl.value = ctx.grade;
      refreshClassDropdown();
      if(ctx.classId) classEl.value = ctx.classId;

      applyContextUI(ctx);

      if(ctx.classId){
        try{ localStorage.setItem("lastClassId", ctx.classId); }catch{}
      }
    }

    function tickLiveClock(){
      const now = new Date();
      liveClockEl.textContent = `×©×¢×”: ${now.toLocaleTimeString("he-IL")}`;

      if(lastFetchedAt){
        lastFetchEl.textContent = `×˜×¢×™× ×” ××—×¨×•× ×”: ${lastFetchedAt.toLocaleString("he-IL")}`;
      }else{
        lastFetchEl.textContent = "×˜×¢×™× ×” ××—×¨×•× ×”: â€”";
      }
    }

    function getCreatedDate(t){
      // createdAt ×™×›×•×œ ×œ×”×™×•×ª ISO / Timestamp / seconds / ms
      return toDateAny(t.createdAt) || toDateAny(t.created) || toDateAny(t._createdAt) || null;
    }

    function applyAndRender(){
      refreshClassDropdown();

      const q = normalize(qEl.value);
      const g = gradeEl.value;
      const c = classEl.value;
      const sort = sortEl.value;

      let arr = ALL.slice();
      if(g !== "all") arr = arr.filter(x => normalize(x.grade) === g);
      if(c !== "all") arr = arr.filter(x => normalize(x.classId) === c);
      if(q) arr = arr.filter(x => blob(x).includes(q));

      arr.sort((a,b)=>{
        if(sort === "titleAsc"){
          return String(a.title||"").localeCompare(String(b.title||""), "he");
        }

        if(sort === "dueSoon"){
          const ad = getDueDate(a)?.getTime() ?? Infinity;
          const bd = getDueDate(b)?.getTime() ?? Infinity;
          return ad - bd;
        }

        // default by createdAt
        const at = getCreatedDate(a)?.getTime() ?? 0;
        const bt = getCreatedDate(b)?.getTime() ?? 0;

        if(sort === "newFirst") return bt - at;
        if(sort === "oldFirst") return at - bt;
        return 0;
      });

      countFilteredEl.textContent = String(arr.length);
      render(arr);
    }

    function render(list){
      if(!list.length){
        itemsEl.innerHTML = `<div class="empty">××™×Ÿ ××©×™××•×ª ×ª×•×××•×ª ×œ×¡×™× ×•×Ÿ.</div>`;
        return;
      }

      itemsEl.innerHTML = list.map(t=>{
        const g = normalize(t.grade);
        const cls = normalize(t.classId);

        const text = (t.text ?? t.body ?? "").toString().trim();
        const due = getDueDate(t);
        const dueTxt = fmtIL(due);

        const created = getCreatedDate(t);
        const createdTxt = created ? created.toLocaleDateString("he-IL") : "";

        const fileUrl = String(t.fileUrl || "").trim();
        const fileName = String(t.fileName || "×¤×ª×— ×§×•×‘×¥").trim();

        const linkUrl = String(t.linkUrl || "").trim();
        const finalLink = fileUrl || linkUrl;

        const linkHtml = finalLink
          ? `<a class="task-link" href="${escapeHtml(finalLink)}" target="_blank" rel="noopener">ğŸ“ ${escapeHtml(fileUrl ? fileName : "×¤×ª×— ×§×•×‘×¥/×§×™×©×•×¨")}</a>`
          : "";

        const imgs = extractImages(t);
        const imgsHtml = imgs.length ? `
          <div class="task-imgs">
            ${imgs.map((url)=>`<img src="${escapeHtml(url)}" alt="×ª××•× ×” ×œ××©×™××”">`).join("")}
          </div>
        ` : "";

        return `
          <article class="task">
            <div class="task-top">
              <h3 class="task-title">${escapeHtml(t.title || "××©×™××”")}</h3>
              <div class="mini-muted">${createdTxt ? `× ×•×¡×£: ${escapeHtml(createdTxt)}` : ""}</div>
            </div>

            <div class="task-meta">
              <span class="tag blue">×©×›×‘×”: ${escapeHtml(gradeLabel(g))}</span>
              <span class="tag">×›×™×ª×”: ${escapeHtml(classIdToLabel(cls))}</span>
              ${t.subject ? `<span class="tag good">ğŸ“˜ ${escapeHtml(t.subject)}</span>` : ""}
              ${dueTxt ? `<span class="tag warn">â° ×“×“×œ×™×™×Ÿ: ${escapeHtml(dueTxt)}</span>` : `<span class="tag warn" style="opacity:.75;">â° ×‘×œ×™ ×“×“×œ×™×™×Ÿ</span>`}
            </div>

            ${text ? `<div class="task-body">${linkifySafe(text)}</div>` : ""}
            ${linkHtml}
            ${imgsHtml}
          </article>
        `;
      }).join("");
    }

    async function loadAll(){
      itemsEl.innerHTML = `<div class="loader">×˜×•×¢×Ÿ ××©×™××•×ªâ€¦</div>`;
      ALL = [];

      for(const g of GRADES){
        try{
          const snap = await getDoc(doc(db, "tasks", g));
          const data = snap.exists() ? (snap.data()||{}) : {};
          const items = Array.isArray(data.items) ? data.items : [];
          for(const t of items){
            ALL.push({ ...t, grade: g });
          }
        }catch(err){
          console.error("load tasks failed:", g, err);
          itemsEl.innerHTML = `
            <div class="empty">
              ×©×’×™××” ×‘×˜×¢×™× ×”. ×‘×“×•×§ Console / Rules.<br>
              ×× ×›×ª×•×‘ <b>permission-denied</b> â€” ×”×—×•×§×™× ×—×•×¡××™× ×§×¨×™××” ×œ- <b>tasks/${g}</b>.
            </div>
          `;
          return;
        }
      }

      lastFetchedAt = new Date();
      countAllEl.textContent = String(ALL.length);
      applyAndRender();
      tickLiveClock();
    }

    function clearFilters(){
      qEl.value = "";
      gradeEl.value = "all";
      refreshClassDropdown();
      classEl.value = "all";
      sortEl.value = "newFirst";

      try{
        const url = new URL(location.href);
        url.searchParams.delete("class");
        url.searchParams.delete("classId");
        url.searchParams.delete("grade");
        history.replaceState({}, "", url.toString());
      }catch{}

      applyContextUI({classId:"", grade:"", hasRef:false});
      applyAndRender();
    }

    // selects sometimes fire change, not input (×™×•×ª×¨ ×‘×˜×•×—)
    qEl.addEventListener("input", applyAndRender);
    gradeEl.addEventListener("change", applyAndRender);
    classEl.addEventListener("change", applyAndRender);
    sortEl.addEventListener("change", applyAndRender);

    refreshBtn.addEventListener("click", loadAll);
    clearBtn.addEventListener("click", clearFilters);

    applyInitialContext();
    await loadAll();

    tickLiveClock();
    setInterval(tickLiveClock, 1000);
  </script>
</body>
</html>
