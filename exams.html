<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>××‘×—× ×™× ×œ×¤×™ ×›×™×ª×” â€“ ×™×¢×¨×ª ×”×¢××§</title>

  <link rel="icon" href="logo.png" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ===== ×¢×™×¦×•×‘ ×“×£ ××‘×—× ×™ ×›×™×ª×” ===== */

    /* ×‘×¨×™×¨×ª ××—×“×œ â€“ ×”×¦×‘×¢×™× ××’×™×¢×™× ××”Ö¾theme ×”×›×œ×œ×™ */
    body[data-page="class-exams"] {
    }

    /* ×“××¨×§ ××•×“ â€“ ×¨×§×¢ ×›×”×” ××™×•×—×“ ×œ×“×£ ××‘×—× ×™× */
    html[data-theme="dark"] body[data-page="class-exams"] {
      background: #0b1120;
      color: #e5f0ff;
    }

    /* ×œ×™×™×˜ ××•×“ â€“ ×¨×§×¢ ×‘×”×™×¨ */
    html[data-theme="light"] body[data-page="class-exams"] {
      background: #eef3fb;
      color: #0b1120;
    }

    .class-exams-wrapper {
      padding-top: 90px;
    }

    .class-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .class-chip {
      border-radius: 999px;
      padding: 8px 18px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: default;
      white-space: nowrap;
    }

    .class-chip span {
      font-weight: 600;
      font-size: 1.05rem;
    }

    .class-chip-badge {
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 0.7rem;
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.6);
      color: #7dd3fc;
    }

    .back-btn-small {
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.85rem;
      text-decoration: none;
    }

    .class-exams-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 780px;
      margin: 0 auto;
    }

    .exam-card {
      border-radius: 18px;
      padding: 14px 16px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.7);
      display: grid;
      grid-template-columns: 1fr auto;
      column-gap: 16px;
      row-gap: 6px;
      align-items: center;
    }

    /* ×œ×™×™×˜ ××•×“ â€“ ×›×¨×˜×™×¡ ×œ×‘×Ÿ */
    html[data-theme="light"] .exam-card {
      background: #ffffff;
      color: #0f172a;
      border: 1px solid #cbd5e1;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    .exam-main-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .exam-meta {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .exam-topic {
      grid-column: 1 / -1;
      font-size: 0.9rem;
      color: #e5e7eb;
      margin-top: 4px;
    }

    /* ×˜×§×¡×˜×™× ×‘×œ×™×™×˜ ××•×“ */
    html[data-theme="light"] .exam-meta,
    html[data-theme="light"] .exam-topic {
      color: #4b5563;
    }

    .exam-date-pill {
      border-radius: 999px;
      padding: 6px 12px;
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.6);
      color: #e0f2fe;
      font-size: 0.8rem;
      text-align: center;
      white-space: nowrap;
    }

    .exam-date-pill span {
      display: block;
    }

    .exam-date-pill .exam-date-main {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .class-empty-msg {
      text-align: center;
      font-size: 0.9rem;
      color: #9ca3af;
      padding: 18px 0;
    }

    @media (max-width: 768px) {
      .class-exams-wrapper {
        padding-top: 80px;
      }

      .class-header-row {
        align-items: flex-start;
        gap: 8px;
      }

      .class-exams-list {
        max-width: 100%;
      }

      .exam-card {
        grid-template-columns: 1fr;
        row-gap: 8px;
      }

      .exam-date-pill {
        justify-self: flex-start;
      }
    }
  </style>
</head>

<body data-page="class-exams">
  <script type="module" src="analytics.js"></script>

  <!-- HEADER ×›××• ×‘××ª×¨ ×”×¨××©×™ -->
  <header class="header-main">
    <div class="container">
      <nav class="nav">
        <div class="nav-left">
          <div class="logo-circle">
            <img
              src="https://i.ibb.co/tp4K737Y/Cropped-circle-image-1.png"
              alt="×¡××œ ×‘×™×ª ×”×¡×¤×¨ ×™×¢×¨×ª ×”×¢××§"
              class="logo-img"
              id="logo-img"
            >
          </div>

          <div>
            <div class="school-title-main">
              ×œ×•×— ××‘×—× ×™× ×œ×¤×™ ×›×™×ª×”
            </div>
            <div class="school-title-sub">
              <a href="index.html#home-exams" style="text-decoration:underline;">
                ×—×–×¨×” ×œ××¡×š ×”××‘×—× ×™× ×”×¨××©×™
              </a>
            </div>
           <div class="school-title-sub"><a href="index.html">×—×–×¨×” ×œ×“×£ ×”×¨××©×™</a></div>

          </div>
        </div>

        <div class="nav-right">
          <a href="index.html#about">××•×“×•×ª</a>
          <a href="index.html#home-news">×—×“×©×•×ª</a>
          <a href="index.html#home-exams">××‘×—× ×™×</a>
          <a href="index.html#grades">×”×©×›×‘×•×ª</a>
          <a href="index.html#contact">×™×¦×™×¨×ª ×§×©×¨</a>
          <a href="redirect-edu.html" class="personal-btn">×œ××¨×—×‘ ×”××™×©×™</a>
          <a href="admin.html" class="btn-outline">Admin</a>
        </div>

        <button id="theme-toggle" class="theme-toggle" type="button">
          ğŸŒ™
        </button>

        <button
          class="nav-toggle"
          type="button"
          aria-label="×¤×ª×— ×ª×¤×¨×™×˜"
          aria-expanded="false">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </nav>
    </div>
  </header>

  <main class="class-exams-wrapper">
    <section class="section-light">
      <div class="container">
        <div class="section-header">
          <h1 id="class-title" class="section-title">××‘×—× ×™× ×œ×›×™×ª×”</h1>
          <p id="class-subtitle" class="section-subtitle">
            ×›××Ÿ ×™×•×¤×™×¢×• ×›×œ ×”××‘×—× ×™× ×”×§×¨×•×‘×™× ×©×œ ×”×›×™×ª×” ×©× ×‘×—×¨×”.
          </p>
        </div>

        <div class="class-header-row">
          <div class="class-chip" id="class-chip">
            <div class="class-chip-badge">×›×™×ª×”</div>
            <span id="class-chip-label">?</span>
          </div>

          <a href="index.html#home-exams" class="btn-outline back-btn-small">
            â† ×—×–×¨×” ×œ××‘×—× ×™ ×”×©×›×‘×•×ª
          </a>
        </div>

        <div id="class-exams-list" class="class-exams-list">
          <!-- ×××•×œ× ×“×¨×š JS -->
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p id="footer-text">Â© ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª ×œ×‘×™×ª ×¡×¤×¨ ×™×¢×¨×ª ×”×¢××§</p>
    </div>
  </footer>

  <div id="to-top">â†‘</div>

  <script src="accessibility.js"></script>

  <!-- JS ×œ×“×£ ×”××‘×—× ×™× ×œ×¤×™ ×›×™×ª×” â€“ REALTIME -->
  <script type="module">
    import { db } from "./firebase-config.js";
    import {
      doc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // ----- ×¤×¨××˜×¨×™× ××”-URL -----
    const params  = new URLSearchParams(window.location.search);
    const grade   = (params.get("grade") || "").toLowerCase();   // z / h / t
    const classId = (params.get("class") || "").toLowerCase();   // z1 / h1 / h4 / t5 ...

    // ××™×–×” ×›×™×ª×•×ª ×§×™×™××•×ª ×‘×›×œ ×©×›×‘×”
    const CLASS_IDS_BY_GRADE = {
      z: ["z1", "z2", "z3", "z4", "z5"],

      // ×©×›×‘×ª ×—' â€“ ×¨×§ ×”×›×™×ª×•×ª ×©×§×™×™××•×ª
      h: ["h1", "h4", "h5", "h6"],

      t: ["t1", "t2", "t3", "t4", "t5"]
    };

    // ×¢×‘×•×¨ ×‘×“×™×§×” × ×•×—×”
    const VALID_CLASSES = CLASS_IDS_BY_GRADE;

    const GRADE_LABEL = {
      z: "×©×›×‘×ª ×–×³",
      h: "×©×›×‘×ª ×—×³",
      t: "×©×›×‘×ª ×˜×³"
    };

    function classIdToLabel(id) {
      const map = {
        z1: "×–1",   z2: "×–2",   z3: "×–3",   z4: "×–4",   z5: "×–5",

        // ×©×›×‘×ª ×—' â€“ ×”×ª×¦×•×’×•×ª ×”×—×“×©×•×ª
        h1: "×—1/7",
        h4: "×—4/8",
        h5: "×—5/9",
        h6: "×—6/10",

        t1: "×˜1",   t2: "×˜2",   t3: "×˜3",   t4: "×˜4",   t5: "×˜5"
      };
      return map[id] || id;
    }

    // ===== ×¤×•× ×§×¦×™×•×ª ×ª××¨×™×š + ×¡×¤×™×¨×” ×œ××—×•×¨ =====

    let examCountdownIntervalId = null;

    function parseExamDateToDateObj(dateStr, timeStr) {
      if (!dateStr) return null;
      let s = String(dateStr).trim();
      if (!s) return null;

      let hh = 8;
      let mm = 0;

      if (timeStr) {
        const tm = String(timeStr).trim().match(/^(\d{1,2}):(\d{2})$/);
        if (tm) {
          hh = Number(tm[1]);
          mm = Number(tm[2]);
        }
      }

      // ×¤×•×¨××˜ ×™×©×¨××œ×™ DD/MM/YY ××• DD/MM/YYYY
      const matchIL = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
      if (matchIL) {
        let day   = Number(matchIL[1]);
        let month = Number(matchIL[2]);
        let year  = Number(matchIL[3]);
        if (year < 100) year = 2000 + year;
        return new Date(year, month - 1, day, hh, mm);
      }

      // ×¤×•×¨××˜ ISO YYYY-MM-DD
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        const [y, m, d] = s.split("-").map(Number);
        return new Date(y, m - 1, d, hh, mm);
      }

      // × ×™×¡×™×•×Ÿ ××—×¨×•×Ÿ
      const dObj = new Date(s);
      return isNaN(dObj.getTime()) ? null : dObj;
    }

    function formatLocalDate(d) {
      try {
        const day   = String(d.getDate()).padStart(2, "0");
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const year  = d.getFullYear();
        return `${day}.${month}.${year}`;
      } catch {
        return "";
      }
    }

    function buildDateTimeLabel(ex, dObjOverride) {
      const dObj = dObjOverride || parseExamDateToDateObj(ex.date, ex.time);
      const baseLabel = dObj ? formatLocalDate(dObj) : (ex.date || "");
      if (ex.time) return `${baseLabel} Â· ${ex.time}`;
      return baseLabel;
    }

    function updateExamCountdownElements() {
      const els = document.querySelectorAll("[data-class-exam-timestamp]");
      if (!els.length) return;
      const now = Date.now();

      els.forEach((el) => {
        const ts = Number(el.dataset.classExamTimestamp);
        if (!ts || Number.isNaN(ts)) {
          el.textContent = "";
          return;
        }

        const diff = ts - now;
        if (diff <= 0) {
          el.textContent = "×”××‘×—×Ÿ ×›×‘×¨ ×”×™×” ××• ××ª×§×™×™× ×¢×›×©×™×•";
          return;
        }

        const totalSeconds = Math.floor(diff / 1000);
        const days    = Math.floor(totalSeconds / (24 * 3600));
        const hours   = Math.floor((totalSeconds % (24 * 3600)) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const parts = [];
        if (days > 0)    parts.push(`${days} ×™××™×`);
        if (hours > 0)   parts.push(`${hours} ×©×¢×•×ª`);
        if (minutes > 0) parts.push(`${minutes} ×“×§×•×ª`);
        parts.push(`${seconds} ×©× ×™×•×ª`);

        el.textContent = `×”××‘×—×Ÿ ×‘×¢×•×“ ${parts.join(" Â· ")}`;
      });
    }

    function startExamCountdownLoop() {
      if (examCountdownIntervalId) return;
      examCountdownIntervalId = setInterval(updateExamCountdownElements, 1000);
    }

    // ===== ×˜×¢×™× ×ª ×”××‘×—× ×™× ×œ×›×™×ª×” â€“ ×‘×–××Ÿ ×××ª =====

    function loadClassExams() {
      const listEl     = document.getElementById("class-exams-list");
      const titleEl    = document.getElementById("class-title");
      const subtitleEl = document.getElementById("class-subtitle");
      const chipLabel  = document.getElementById("class-chip-label");

      // ×‘×“×™×§×ª ×¤×¨××˜×¨×™×
      if (
        !grade ||
        !classId ||
        !VALID_CLASSES[grade] ||
        !VALID_CLASSES[grade].includes(classId)
      ) {
        titleEl.textContent = "×©×’×™××” ×‘× ×ª×•× ×™ ×”×›×ª×•×‘×ª";
        subtitleEl.textContent =
          "×”×§×™×©×•×¨ ××™× ×• ×ª×§×™×Ÿ. × ×¡×• ×œ×—×–×•×¨ ×œ××¡×š ×”××‘×—× ×™× ×”×¨××©×™ ×•×œ×‘×—×•×¨ ×©×•×‘ ××ª ×”×›×™×ª×”.";
        listEl.innerHTML =
          '<p class="class-empty-msg">×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”××‘×—× ×™× â€“ ×›×™×ª×” ×œ× ×§×™×™××ª.</p>';
        if (chipLabel) chipLabel.textContent = "?";
        return;
      }

      const classLabel = classIdToLabel(classId);
      const gradeLabel = GRADE_LABEL[grade] || "";

      titleEl.textContent =
        `××‘×—× ×™× Â· ×›×™×ª×” ${classLabel}`;
      subtitleEl.textContent =
        `×›×œ ×”××‘×—× ×™× ×”×§×¨×•×‘×™× ×©×œ ×›×™×ª×” ${classLabel} (${gradeLabel}).`;
      if (chipLabel) chipLabel.textContent = classLabel;

      // ××¦×‘ ×˜×¢×™× ×” ×¨××©×•× ×™
      listEl.innerHTML =
        '<p class="class-empty-msg">×˜×•×¢×Ÿ ××‘×—× ×™×...</p>';

      try {
        const refDoc = doc(db, "exams", grade); // ××¡××š ×©×œ ×”×©×›×‘×” (z/h/t)

        // ×××–×™×Ÿ ×‘×–××Ÿ ×××ª ×œ×©×™× ×•×™×™× ×‘××¡××š
        onSnapshot(
          refDoc,
          (snap) => {
            const data     = snap.exists() ? snap.data() : { items: [] };
            const allExams = data.items || [];

            const forClass = allExams
              .filter(
                (ex) =>
                  ex.classId &&
                  String(ex.classId).toLowerCase() === classId.toLowerCase()
              )
              .map((ex) => ({
                ...ex,
                _dateObj: parseExamDateToDateObj(ex.date, ex.time)
              }))
              .filter((ex) => ex._dateObj instanceof Date && !isNaN(ex._dateObj));

            if (!forClass.length) {
              listEl.innerHTML =
                '<p class="class-empty-msg">×›×¨×’×¢ ××™×Ÿ ××‘×—× ×™× ×¨×©×•××™× ×œ×›×™×ª×” ×–×•.</p>';
              return;
            }

            // ×œ××™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š
            forClass.sort((a, b) => a._dateObj - b._dateObj);

            listEl.innerHTML = "";

            forClass.forEach((ex) => {
              const dObj = ex._dateObj;
              const ts   = dObj.getTime();

              const day       = String(dObj.getDate()).padStart(2, "0");
              const month     = String(dObj.getMonth() + 1).padStart(2, "0");
              const yearShort = String(dObj.getFullYear()).slice(-2);

              const card = document.createElement("div");
              card.className = "exam-card";
              card.innerHTML = `
                <div>
                  <div class="exam-main-title">${ex.subject || "××‘×—×Ÿ"}</div>
                  <div class="exam-meta">
                    ${buildDateTimeLabel(ex, dObj)}
                  </div>
                </div>
                <div class="exam-date-pill">
                  <span class="exam-date-main">${day}/${month}</span>
                  <span>${yearShort}</span>
                </div>
                <div class="exam-topic">
                  ${ex.topic || "×œ×œ× ×ª×™××•×¨ ××¤×•×¨×˜."}
                </div>
                <div class="class-exam-countdown" data-class-exam-timestamp="${ts}"></div>
              `;
              listEl.appendChild(card);
            });

            updateExamCountdownElements();
            startExamCountdownLoop();
          },
          (err) => {
            console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ××‘×—× ×™× ×‘×–××Ÿ ×××ª:", err);
            listEl.innerHTML =
              '<p class="class-empty-msg">××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”××‘×—× ×™×. × ×¡×• ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.</p>';
          }
        );
      } catch (err) {
        console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ×”××‘×—× ×™×:", err);
        listEl.innerHTML =
          '<p class="class-empty-msg">××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”××‘×—× ×™×. × ×¡×• ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.</p>';
      }
    }

    loadClassExams();
  </script>

  <!-- app.js ×‘×©×‘×™×œ ××¦×‘ ×›×”×” / ×ª×¤×¨×™×˜ ××•×‘×™×™×œ ×•×›×•' -->
  <script type="module" src="app.js"></script>
</body>
</html>
