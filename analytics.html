<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>×× ×œ×™×˜×™×§×•×ª â€“ ×™×¢×¨×ª ×”×¢××§</title>

  <!-- âœ… ×—×©×•×‘: ×–×” ×”×“×£ ×©×œ ×”×“×©×‘×•×¨×“ -->
  <meta name="theme-color" content="#020617" />

  <style>
    :root{
      --bg:#020617;
      --card:#0b1120;
      --card2:#0a1325;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
      --accent:#38bdf8;
      --accent2:#22c55e;
      --warn:#f97373;
      --shadow: 0 18px 48px rgba(15,23,42,0.65);
    }

    *{ box-sizing:border-box; }
    body{
      background: radial-gradient(circle at 15% 10%, rgba(56,189,248,0.16), transparent 45%),
                  radial-gradient(circle at 80% 20%, rgba(34,197,94,0.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      margin: 0;
      padding: 18px;
      min-height: 100vh;
    }

    .wrap{ max-width: 1200px; margin: 0 auto; }

    /* ===== Topbar ===== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: rgba(56,189,248,0.12);
      border:1px solid rgba(56,189,248,0.28);
      box-shadow: 0 10px 28px rgba(56,189,248,0.10);
      display:flex;align-items:center;justify-content:center;
      font-size: 1.2rem;
    }
    h1{
      font-size: 1.25rem;
      margin: 0;
      letter-spacing: .2px;
    }
    .subtitle{
      font-size: .9rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      cursor:pointer;
      padding: 9px 14px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.35);
      background: rgba(2,6,23,0.35);
      color: var(--text);
      text-decoration: none;
      font-size: .9rem;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 10px 28px rgba(15,23,42,0.30);
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      background: rgba(56,189,248,0.10);
      box-shadow: 0 14px 36px rgba(15,23,42,0.40);
    }
    .btn.secondary{
      border-color: rgba(148,163,184,0.26);
    }
    .btn.danger{
      border-color: rgba(249,115,115,0.35);
      background: rgba(249,115,115,0.08);
    }

    /* ===== Status ===== */
    .status{
      text-align:center;
      margin: 10px 0 14px;
      font-size: 0.95rem;
      color: var(--muted);
    }
    .status.error{ color: var(--warn); }

    /* ===== Filters ===== */
    .filters{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:stretch;
      margin-bottom: 14px;
    }
    .filter{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(148,163,184,0.16);
      border-radius: 16px;
      padding: 10px 12px;
      min-width: 240px;
      flex: 1;
      box-shadow: var(--shadow);
    }
    .filter label{
      display:block;
      font-size: .85rem;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 700;
    }
    .filter select{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(2,6,23,0.40);
      color: var(--text);
      outline:none;
    }

    /* ===== Layout ===== */
    .layout{
      display:grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr);
      gap: 14px;
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .filter{ min-width: 0; }
    }

    .card{
      background: linear-gradient(180deg, rgba(11,17,32,0.95), rgba(11,17,32,0.78));
      border-radius: 18px;
      padding: 14px 16px;
      border: 1px solid rgba(148,163,184,0.16);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset: -50% -50% auto auto;
      width: 260px;
      height: 260px;
      background: radial-gradient(circle, rgba(56,189,248,0.16), transparent 60%);
      filter: blur(2px);
      pointer-events:none;
    }

    .card h2{
      font-size: 1rem;
      margin: 0 0 10px 0;
      color: #7dd3fc;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .78rem;
      border: 1px solid rgba(148,163,184,0.24);
      color: var(--text);
      background: rgba(2,6,23,0.25);
      white-space: nowrap;
    }
    .pill.good{
      border-color: rgba(34,197,94,0.30);
      background: rgba(34,197,94,0.10);
    }
    .pill.info{
      border-color: rgba(56,189,248,0.30);
      background: rgba(56,189,248,0.10);
    }

    /* ===== Metrics ===== */
    .metrics{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap:10px;
      margin-bottom: 6px;
    }
    .metric{
      background: rgba(2,6,23,0.55);
      border-radius: 14px;
      padding: 12px 10px;
      border: 1px solid rgba(148,163,184,0.16);
      text-align: center;
    }
    .metric-label{
      font-size: .82rem;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 700;
    }
    .metric-value{
      font-size: 1.35rem;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .metric-sub{
      margin-top: 4px;
      font-size: .8rem;
      color: var(--muted);
    }

    /* ===== Tables ===== */
    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
      table-layout: fixed;
    }
    th, td{
      padding: 8px 10px;
      border-bottom: 1px solid rgba(148,163,184,0.14);
      text-align:right;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th{
      background: rgba(2,6,23,0.55);
      color: #7dd3fc;
      font-weight: 800;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:hover{ background: rgba(17,24,39,0.55); }

    .section-title-sm{
      font-size: 0.86rem;
      margin: 12px 0 4px;
      color: var(--muted);
      font-weight: 800;
    }

    .bar-row{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .bar-track{
      flex:1;
      height: 9px;
      background: rgba(2,6,23,0.60);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(148,163,184,0.10);
    }
    .bar-fill{
      height:100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      width: 0%;
      transition: width .35s ease;
    }
    .bar-label{
      min-width: 46px;
      text-align:left;
      font-size: 0.76rem;
      color: var(--muted);
    }

    .empty{
      color: var(--muted);
      padding: 10px 0;
      text-align:center;
    }

    /* ===== Footer hint ===== */
    .foot{
      margin-top: 14px;
      text-align:center;
      color: var(--muted);
      font-size: .85rem;
    }
    .foot code{
      background: rgba(2,6,23,0.55);
      border: 1px solid rgba(148,163,184,0.14);
      padding: 2px 8px;
      border-radius: 10px;
      color: #cbd5e1;
    }
  </style>
</head>

<!-- âœ… ×”×“××©×‘×•×¨×“ ×¦×¨×™×š ××ª ×–×” ×›×“×™ ×©-analytics.js ×œ× ×™× ×¡×” ×œ×œ×•×’ -->
<body data-page="analytics-dashboard">

  <div class="wrap">
    <!-- TOP -->
    <div class="topbar">
      <div class="brand">
        <div class="logo">ğŸ“Š</div>
        <div>
          <h1>×× ×œ×™×˜×™×§×•×ª â€“ ×™×¢×¨×ª ×”×¢××§</h1>
          <div class="subtitle">Firestore Â· ×›× ×™×¡×•×ª ×œ×¤×™ ×“×£ / ×™×•× / ×©×¢×” / ×©×›×‘×” / ×›×™×ª×”</div>
        </div>
      </div>

      <div class="actions">
        <a class="btn secondary" href="index.html">â† ×“×£ ×”×‘×™×ª</a>
        <button class="btn" id="refreshBtn" type="button">×¨×¢× ×•×Ÿ</button>
        <button class="btn danger" id="signOutBtn" type="button">×”×ª× ×ª×§×•×ª</button>
      </div>
    </div>

    <div id="status" class="status">×‘×•×“×§ ×”×¨×©××•×ª...</div>

    <!-- Filters (UI only, ×¢×•×‘×“ ×¢×œ ×”× ×ª×•× ×™× ×©×›×‘×¨ × ×˜×¢× ×•) -->
    <div class="filters" id="filters" style="display:none;">
      <div class="filter">
        <label for="rangeSelect">×˜×•×•×— × ×ª×•× ×™× ×œ×”×¦×’×”</label>
        <select id="rangeSelect">
          <option value="all">×”×›×•×œ (××” ×©×™×© ×‘-DB)</option>
          <option value="30">30 ×™××™× ××—×¨×•× ×™×</option>
          <option value="14">14 ×™××™× ××—×¨×•× ×™×</option>
          <option value="7">7 ×™××™× ××—×¨×•× ×™×</option>
          <option value="today">×”×™×•× ×‘×œ×‘×“</option>
        </select>
      </div>

      <div class="filter">
        <label for="pageFocus">×¤×•×§×•×¡ ×“×£ (×œ×¡×™×›×•× ×§×˜×Ÿ)</label>
        <select id="pageFocus">
          <option value="all">×›×œ ×”×“×¤×™×</option>
          <option value="home">×“×£ ×”×‘×™×ª</option>
          <option value="home-exams">×œ×•×— ××‘×—× ×™× (×¨××©×™)</option>
          <option value="class-exams">××‘×—× ×™× ×œ×¤×™ ×›×™×ª×”</option>
          <option value="classes">×“×£ ×›×™×ª×”</option>
          <option value="admin">×¤×× ×œ × ×™×”×•×œ</option>
          <option value="analytics-dashboard">×× ×œ×™×˜×™×§×¡</option>
        </select>
      </div>
    </div>

    <div class="layout" id="layout" style="display:none;">
      <!-- LEFT -->
      <div>
        <div class="card">
          <h2>
            ×¡×™×›×•× ×›×œ×œ×™
            <span class="pill info" id="pillRange">×˜×•×•×—: ×”×›×•×œ</span>
          </h2>

          <div class="metrics">
            <div class="metric">
              <div class="metric-label">×¡×”"×› ×¦×¤×™×•×ª</div>
              <div class="metric-value" id="metric-total-views">-</div>
              <div class="metric-sub" id="metric-total-note">â€”</div>
            </div>

            <div class="metric">
              <div class="metric-label">×“×¤×™× ×©×•× ×™×</div>
              <div class="metric-value" id="metric-unique-pages">-</div>
              <div class="metric-sub">× ×¡×¤×¨ ××”× ×ª×•× ×™×</div>
            </div>

            <div class="metric">
              <div class="metric-label">×™××™× ×¢× ×¤×¢×™×œ×•×ª</div>
              <div class="metric-value" id="metric-active-days">-</div>
              <div class="metric-sub">×›××” ×ª××¨×™×›×™× ×”×•×¤×™×¢×•</div>
            </div>
          </div>

          <div class="section-title-sm">×“×£ "××‘×—× ×™×" â€“ ×¦×¤×™×•×ª (pageId = home-exams)</div>
          <div id="metric-exams-views" class="metric-value" style="font-size:1.05rem;">-</div>

          <div class="section-title-sm">×“×£ "××‘×—× ×™× ×œ×¤×™ ×›×™×ª×”" â€“ ×¦×¤×™×•×ª (pageId = class-exams)</div>
          <div id="metric-class-exams-views" class="metric-value" style="font-size:1.05rem;">-</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h2>×¦×¤×™×•×ª ×œ×¤×™ ×™×•× (×›×œ ×”×“×¤×™×) <span class="pill good" id="pillDays">×¢×“×›×•×Ÿ: â€”</span></h2>

          <table>
            <thead>
              <tr>
                <th style="width:120px">×ª××¨×™×š</th>
                <th style="width:80px">×¦×¤×™×•×ª</th>
                <th>×’×¨×£</th>
              </tr>
            </thead>
            <tbody id="table-by-day"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="card">
          <h2>×¦×¤×™×•×ª ×œ×¤×™ ×“×£</h2>
          <table>
            <thead>
              <tr>
                <th>×“×£</th>
                <th style="width:80px">×¦×¤×™×•×ª</th>
              </tr>
            </thead>
            <tbody id="table-by-page"></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:12px;">
          <h2>×¤×¢×™×œ×•×ª ×œ×¤×™ ×©×¢×” / ×©×›×‘×” / ×›×™×ª×”</h2>

          <div class="section-title-sm">×œ×¤×™ ×©×¢×” (×›×œ ×”×“×¤×™×)</div>
          <table>
            <thead>
              <tr>
                <th style="width:90px">×©×¢×”</th>
                <th style="width:80px">×¦×¤×™×•×ª</th>
                <th>×¤×¡</th>
              </tr>
            </thead>
            <tbody id="table-by-hour"></tbody>
          </table>

          <div class="section-title-sm">×œ×¤×™ ×©×›×‘×” â€“ ×›×œ ×”×“×¤×™×</div>
          <table>
            <thead>
              <tr>
                <th>×©×›×‘×”</th>
                <th style="width:80px">×¦×¤×™×•×ª</th>
              </tr>
            </thead>
            <tbody id="table-by-grade"></tbody>
          </table>

          <div class="section-title-sm">×œ×¤×™ ×›×™×ª×” â€“ ×›×œ ×”×“×¤×™×</div>
          <table>
            <thead>
              <tr>
                <th>×›×™×ª×”</th>
                <th style="width:80px">×¦×¤×™×•×ª</th>
              </tr>
            </thead>
            <tbody id="table-by-class"></tbody>
          </table>

          <div class="section-title-sm">×“×£ ×”××‘×—× ×™× ×”×¨××©×™ â€“ ×œ×¤×™ ×©×›×‘×”</div>
          <table>
            <thead>
              <tr>
                <th>×©×›×‘×”</th>
                <th style="width:140px">×¦×¤×™×•×ª (home-exams)</th>
              </tr>
            </thead>
            <tbody id="table-exams-by-grade"></tbody>
          </table>

          <div class="section-title-sm">×“×£ "××‘×—× ×™× ×œ×¤×™ ×›×™×ª×”" â€“ ×œ×¤×™ ×›×™×ª×”</div>
          <table>
            <thead>
              <tr>
                <th>×›×™×ª×”</th>
                <th style="width:140px">×¦×¤×™×•×ª (class-exams)</th>
              </tr>
            </thead>
            <tbody id="table-classExams-by-class"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="foot">
      ×˜×™×¤: ×›×“×™ ×©×”×œ×•×’×™× ×™×ª×¤×¡×• ×‘×›×œ ×”××ª×¨, ×‘×›×œ ×¢××•×“ ×ª×©×™× ×‘Ö¾<code>&lt;body data-page="..."&gt;</code> ×•××– ×œ××˜×”:
      <code>&lt;script type="module" src="analytics.js"&gt;&lt;/script&gt;</code>
    </div>
  </div>

<script type="module">
  import { db, auth } from "./firebase-config.js";
  import {
    collection,
    getDocs,
    query,
    orderBy,
    limit
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

  /* =======================
    SETTINGS
  ======================= */
  const OWNER_EMAILS = ["nadavp1119@gmail.com"]; // âœ… ×ª×•×¡×™×£ ×× ×™×© ×¢×•×“
  const statusEl = document.getElementById("status");
  const layoutEl = document.getElementById("layout");
  const filtersEl = document.getElementById("filters");

  const refreshBtn = document.getElementById("refreshBtn");
  const signOutBtn = document.getElementById("signOutBtn");

  const pillRange = document.getElementById("pillRange");
  const pillDays = document.getElementById("pillDays");

  const elTotalViews = document.getElementById("metric-total-views");
  const elUniquePages = document.getElementById("metric-unique-pages");
  const elActiveDays = document.getElementById("metric-active-days");
  const elExamsViews = document.getElementById("metric-exams-views");
  const elClassExamsViews = document.getElementById("metric-class-exams-views");
  const elTotalNote = document.getElementById("metric-total-note");

  const tbodyByDay = document.getElementById("table-by-day");
  const tbodyByPage = document.getElementById("table-by-page");
  const tbodyByHour = document.getElementById("table-by-hour");
  const tbodyByGrade = document.getElementById("table-by-grade");
  const tbodyByClass = document.getElementById("table-by-class");
  const tbodyExamsByGrade = document.getElementById("table-exams-by-grade");
  const tbodyClassExamsByClass = document.getElementById("table-classExams-by-class");

  const rangeSelect = document.getElementById("rangeSelect");
  const pageFocus = document.getElementById("pageFocus");

  /* =======================
    HELPERS
  ======================= */
  function humanPageId(pageId) {
    if (!pageId) return "-";
    const map = {
      "index": "×“×£ ×”×‘×™×ª",
      "home": "×“×£ ×”×‘×™×ª (home)",
      "classes": "×“×¤×™ ×›×™×ª×” (class.html)",
      "class": "×“×¤×™ ×›×™×ª×” (class)",
      "home-exams": "×œ×•×— ××‘×—× ×™× (×¢××•×“ ×¨××©×™)",
      "exams": "×œ×•×— ××‘×—× ×™×",
      "class-exams": "××‘×—× ×™× ×œ×¤×™ ×›×™×ª×”",
      "admin": "×¤×× ×œ × ×™×”×•×œ",
      "logs": "×œ×•×’×™×",
      "analytics-dashboard": "×× ×œ×™×˜×™×§×•×ª"
    };
    return map[pageId] || pageId;
  }

  function classIdToLabel(classId) {
    const map = {
      z1: "×–1", z2: "×–2", z3: "×–3", z4: "×–4", z5: "×–5",
      h1: "×—1", h2: "×—2", h3: "×—3", h4: "×—4", h5: "×—5", h6: "×—6",
      t1: "×˜1", t2: "×˜2", t3: "×˜3", t4: "×˜4", t5: "×˜5"
    };
    return map[String(classId || "").toLowerCase()] || classId || "-";
  }

  function gradeToLabel(grade) {
    const map = { z: "×–", h: "×—", t: "×˜" };
    return map[String(grade || "").toLowerCase()] || grade || "-";
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function renderBarCell(value, max) {
    const safeVal = Number(value || 0);
    const safeMax = Number(max || 0);
    const pct = !safeMax ? 0 : Math.max(4, Math.round((safeVal / safeMax) * 100));
    return `
      <div class="bar-row">
        <div class="bar-track">
          <div class="bar-fill" style="width:${pct}%;"></div>
        </div>
        <div class="bar-label">${safeVal}</div>
      </div>
    `;
  }

  function formatNow() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function dayKeyFromDate(d){
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function withinRange(dateKey, rangeVal){
    if (rangeVal === "all") return true;
    if (rangeVal === "today") return dateKey === dayKeyFromDate(new Date());

    const days = Number(rangeVal);
    if (!days || isNaN(days)) return true;

    const d = new Date(dateKey + "T00:00:00");
    const cutoff = new Date();
    cutoff.setHours(0,0,0,0);
    cutoff.setDate(cutoff.getDate() - (days - 1));
    return d >= cutoff;
  }

  /* =======================
    DATA CACHE
  ======================= */
  let cachedViewsRows = []; // analytics_pageViews
  let cachedDailyRows = []; // analytics_daily
  let cachedEvents = [];    // analytics_events (×™×›×•×œ ×œ×”×™×•×ª ×¨×™×§)

  /* =======================
    LOAD
  ======================= */
  async function fetchAll() {
    // âœ… daily totals (××¡××š ××—×“ ×œ×™×•×)
    const qDaily = query(collection(db, "analytics_daily"), orderBy("dateKey", "asc"), limit(400));
    const snapDaily = await getDocs(qDaily);
    cachedDailyRows = snapDaily.docs.map(d => d.data());

    // âœ… pageViews (×™×•×+×“×£)
    const qViews = query(collection(db, "analytics_pageViews"), orderBy("dateKey", "asc"), limit(8000));
    const snapViews = await getDocs(qViews);
    cachedViewsRows = snapViews.docs.map(d => d.data());

    // events (×©×¢×”/×©×›×‘×”/×›×™×ª×”) â€” ×¨×§ ×× ×‘×××ª ××©×ª××©×™× ×‘×–×”
    // ×× ENABLE_RAW_EVENTS=false ××¦×œ×š, ×›× ×¨××” ×™×”×™×” ×¨×™×§ ×•×–×” ×‘×¡×“×¨
    try{
      const qEvents = query(collection(db, "analytics_events"), orderBy("dateKey", "desc"), limit(12000));
      const snapEvents = await getDocs(qEvents);
      cachedEvents = snapEvents.docs.map(d => d.data());
    } catch {
      cachedEvents = [];
    }
  }

  /* =======================
    RENDER
  ======================= */
  function render() {
    const rangeVal = rangeSelect.value;
    const focusVal = pageFocus.value;

    pillRange.textContent = `×˜×•×•×—: ${
      rangeVal === "all" ? "×”×›×•×œ" :
      rangeVal === "today" ? "×”×™×•×" :
      `${rangeVal} ×™××™×`
    }`;

    pillDays.textContent = `×¢×“×›×•×Ÿ: ${formatNow()}`;

    /* ---- 1) DAILY (analytics_daily) ---- */
    const dailyRows = cachedDailyRows
      .filter(r => withinRange(String(r.dateKey || ""), rangeVal));

    const daysArr = dailyRows
      .map(r => ({ dateKey: String(r.dateKey || ""), views: Number(r.views || 0) }))
      .filter(r => r.dateKey)
      .sort((a,b) => (a.dateKey > b.dateKey ? -1 : 1)); // ×™×•×¨×“

    const totalViewsDaily = daysArr.reduce((s, r) => s + r.views, 0);

    // ×˜×‘×œ×ª ×œ×¤×™ ×™××™× (××‘×•×¡×¡ daily!)
    const maxDayViews = daysArr.reduce((m, r) => Math.max(m, r.views), 0);
    tbodyByDay.innerHTML = "";
    if (!daysArr.length) {
      tbodyByDay.innerHTML = `<tr><td colspan="3" class="empty">××™×Ÿ × ×ª×•× ×™× ×¢×“×™×™×Ÿ.</td></tr>`;
    } else {
      daysArr.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.dateKey)}</td>
          <td>${r.views}</td>
          <td>${renderBarCell(r.views, maxDayViews)}</td>
        `;
        tbodyByDay.appendChild(tr);
      });
    }

    /* ---- 2) PAGEVIEWS (analytics_pageViews) ---- */
    const viewsRows = cachedViewsRows
      .filter(r => withinRange(String(r.dateKey || ""), rangeVal));

    const pagesSet = new Set();
    const pagesMap = new Map(); // pageId -> sum

    viewsRows.forEach(r => {
      const v = Number(r.views || 0);
      if (r.pageId) pagesSet.add(r.pageId);
      const pid = String(r.pageId || "");
      if (pid) pagesMap.set(pid, (pagesMap.get(pid) || 0) + v);
    });

    const examsViews = pagesMap.get("home-exams") || 0;
    const classExamsViews = pagesMap.get("class-exams") || 0;

    // âœ… ×¡×”"×› ×¦×¤×™×•×ª: ×œ×§×—×ª ××”-DAILY (××“×•×™×§)
    elTotalViews.textContent = totalViewsDaily.toString();
    elUniquePages.textContent = pagesSet.size.toString();
    elActiveDays.textContent = daysArr.length.toString();
    elExamsViews.textContent = examsViews.toString();
    elClassExamsViews.textContent = classExamsViews.toString();
    elTotalNote.textContent = (focusVal === "all")
      ? "×›×œ ×”×“×¤×™×"
      : `×¤×•×§×•×¡: ${humanPageId(focusVal)}`;

    // ×˜×‘×œ×ª ×œ×¤×™ ×“×¤×™×
    const pagesArr = Array.from(pagesMap.entries())
      .map(([pageId, views]) => ({ pageId, views }))
      .sort((a, b) => b.views - a.views);

    tbodyByPage.innerHTML = "";
    if (!pagesArr.length) {
      tbodyByPage.innerHTML = `<tr><td colspan="2" class="empty">××™×Ÿ × ×ª×•× ×™× ×¢×“×™×™×Ÿ.</td></tr>`;
    } else {
      pagesArr.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td title="${escapeHtml(r.pageId)}">${escapeHtml(humanPageId(r.pageId))}</td>
          <td>${r.views}</td>
        `;
        tbodyByPage.appendChild(tr);
      });
    }

    /* ---- 3) EVENTS (×× ×™×©) ---- */
    const events = cachedEvents.filter(ev => withinRange(String(ev.dateKey || ""), rangeVal));

    const hourMap = new Map();        // "00".."23" -> count
    const gradeMap = new Map();       // grade -> count
    const classMap = new Map();       // classId -> count
    const examsByGrade = new Map();   // grade -> count (home-exams)
    const classExamsByClass = new Map(); // classId -> count (class-exams)

    events.forEach(ev => {
      const h = String(ev.hour ?? "??");
      hourMap.set(h, (hourMap.get(h) || 0) + 1);

      if (ev.grade) {
        const g = String(ev.grade).toLowerCase();
        gradeMap.set(g, (gradeMap.get(g) || 0) + 1);
      }
      if (ev.classId) {
        const cid = String(ev.classId).toLowerCase();
        classMap.set(cid, (classMap.get(cid) || 0) + 1);
      }

      if (ev.pageId === "home-exams" && ev.grade) {
        const g = String(ev.grade).toLowerCase();
        examsByGrade.set(g, (examsByGrade.get(g) || 0) + 1);
      }

      if (ev.pageId === "class-exams" && ev.classId) {
        const cid = String(ev.classId).toLowerCase();
        classExamsByClass.set(cid, (classExamsByClass.get(cid) || 0) + 1);
      }
    });

    // ×œ×¤×™ ×©×¢×”: ××¦×™×’ 00..23 ×’× ×× ×¨×™×§
    const hourArr = [];
    for (let i = 0; i < 24; i++) {
      const hh = String(i).padStart(2, "0");
      hourArr.push({ hour: hh, count: hourMap.get(hh) || 0 });
    }
    const maxHour = hourArr.reduce((m, r) => Math.max(m, r.count), 0);

    tbodyByHour.innerHTML = "";
    if (!events.length) {
      tbodyByHour.innerHTML = `<tr><td colspan="3" class="empty">××™×Ÿ ×¢×“×™×™×Ÿ × ×ª×•× ×™ ×©×¢×•×ª (analytics_events ×›×‘×•×™).</td></tr>`;
    } else {
      hourArr.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.hour}:00</td>
          <td>${r.count}</td>
          <td>${renderBarCell(r.count, maxHour)}</td>
        `;
        tbodyByHour.appendChild(tr);
      });
    }

    // ×œ×¤×™ ×©×›×‘×”
    const gradeArr = Array.from(gradeMap.entries())
      .map(([grade, count]) => ({ grade, count }))
      .sort((a, b) => b.count - a.count);

    tbodyByGrade.innerHTML = "";
    if (!gradeArr.length) {
      tbodyByGrade.innerHTML = `<tr><td colspan="2" class="empty">××™×Ÿ ×¢×“×™×™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×¢× grade (analytics_events ×›×‘×•×™).</td></tr>`;
    } else {
      gradeArr.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="pill">${escapeHtml(gradeToLabel(r.grade))}</span></td>
          <td>${r.count}</td>
        `;
        tbodyByGrade.appendChild(tr);
      });
    }

    // ×œ×¤×™ ×›×™×ª×”
    const classArr = Array.from(classMap.entries())
      .map(([classId, count]) => ({ classId, count }))
      .sort((a, b) => b.count - a.count);

    tbodyByClass.innerHTML = "";
    if (!classArr.length) {
      tbodyByClass.innerHTML = `<tr><td colspan="2" class="empty">××™×Ÿ ×¢×“×™×™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×¢× classId (analytics_events ×›×‘×•×™).</td></tr>`;
    } else {
      classArr.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="pill">${escapeHtml(classIdToLabel(r.classId))}</span></td>
          <td>${r.count}</td>
        `;
        tbodyByClass.appendChild(tr);
      });
    }

    // home-exams ×œ×¤×™ ×©×›×‘×”
    const examsGradeArr = Array.from(examsByGrade.entries())
      .map(([grade, count]) => ({ grade, count }))
      .sort((a, b) => b.count - a.count);

    tbodyExamsByGrade.innerHTML = "";
    if (!examsGradeArr.length) {
      tbodyExamsByGrade.innerHTML = `<tr><td colspan="2" class="empty">××™×Ÿ ×¢×“×™×™×Ÿ ×¦×¤×™×•×ª home-exams ×¢× grade (analytics_events ×›×‘×•×™).</td></tr>`;
    } else {
      examsGradeArr.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="pill">${escapeHtml(gradeToLabel(r.grade))}</span></td>
          <td>${r.count}</td>
        `;
        tbodyExamsByGrade.appendChild(tr);
      });
    }

    // class-exams ×œ×¤×™ ×›×™×ª×”
    const classExamsArr = Array.from(classExamsByClass.entries())
      .map(([classId, count]) => ({ classId, count }))
      .sort((a, b) => b.count - a.count);

    tbodyClassExamsByClass.innerHTML = "";
    if (!classExamsArr.length) {
      tbodyClassExamsByClass.innerHTML = `<tr><td colspan="2" class="empty">××™×Ÿ ×¢×“×™×™×Ÿ ×¦×¤×™×•×ª class-exams ×¢× classId (analytics_events ×›×‘×•×™).</td></tr>`;
    } else {
      classExamsArr.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="pill">${escapeHtml(classIdToLabel(r.classId))}</span></td>
          <td>${r.count}</td>
        `;
        tbodyClassExamsByClass.appendChild(tr);
      });
    }
  }

  async function loadAllAndRender() {
    statusEl.classList.remove("error");
    statusEl.textContent = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";
    refreshBtn.disabled = true;
    try {
      await fetchAll();
      filtersEl.style.display = "";
      layoutEl.style.display = "";
      render();
      statusEl.textContent = "× ×˜×¢×Ÿ ×‘×”×¦×œ×—×”.";
    } catch (err) {
      console.error(err);
      statusEl.classList.add("error");
      statusEl.textContent = "×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×. ×ª×‘×“×•×§ Console.";
    } finally {
      refreshBtn.disabled = false;
    }
  }

  /* =======================
    AUTH + UI
  ======================= */
  refreshBtn.addEventListener("click", () => loadAllAndRender());

  signOutBtn.addEventListener("click", async () => {
    try {
      await signOut(auth);
      location.href = "admin.html";
    } catch (e) {
      console.error(e);
      alert("×œ× ×”×¦×œ×—×ª×™ ×œ×”×ª× ×ª×§. ×ª×‘×“×•×§ Console.");
    }
  });

  rangeSelect.addEventListener("change", () => render());
  pageFocus.addEventListener("change", () => render());

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      statusEl.classList.add("error");
      statusEl.innerHTML = `
        ××™×Ÿ ×œ×š ×’×™×©×”. ×”×ª×—×‘×¨ ×“×¨×š ×¢××•×“ ×”× ×™×”×•×œ.<br>
        <a class="btn secondary" href="admin.html">×œ×¢××•×“ ×”×”×ª×—×‘×¨×•×ª</a>
      `;
      return;
    }

    const email = String(user.email || "").toLowerCase();
    const allowed = OWNER_EMAILS.map(e => e.toLowerCase()).includes(email);

    if (!allowed) {
      statusEl.classList.add("error");
      statusEl.textContent = "×”××©×ª××© " + email + " ××™× ×• ××•×¨×©×” ×œ×¦×¤×•×ª ×‘×× ×œ×™×˜×™×§×•×ª.";
      return;
    }

    loadAllAndRender();
  });
</script>


  <!-- âœ… ×©×™× ××ª ×–×” ×›×“×™ ×©×”×“×©×‘×•×¨×“ ×’× ×™×•×¤×™×¢ ×‘×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×œ×š (×¨×§ ×× ××ª×” ×¨×•×¦×”),
       ××‘×œ ×›×¨×’×¢ analytics.js ×©×œ×š ×œ× ×›×•×ª×‘ ×‘×“××©×‘×•×¨×“ ×‘×’×œ×œ data-page=analytics-dashboard.
       ×× ×ª×¨×¦×” ×©×›×Ÿ ×™×™×¡×¤×¨ â€” ×ª×’×™×“ ×•××©× ×” ×œ×š ×œ×•×’×™×§×”. -->
  <script type="module" src="analytics.js"></script>
</body>
</html>
