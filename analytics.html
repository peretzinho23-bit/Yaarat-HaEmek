<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>אנליטיקות – יערת העמק</title>

  <style>
    body {
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #38bdf8;
      margin-bottom: 8px;
    }
    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 20px;
    }
    .status {
      text-align: center;
      margin-bottom: 15px;
      font-size: 0.95rem;
    }
    .status.error {
      color: #f97373;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr);
      gap: 16px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      background: #0b1120;
      border-radius: 16px;
      padding: 14px 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 12px 30px rgba(15,23,42,0.65);
    }
    .card h2 {
      font-size: 1rem;
      margin: 0 0 10px 0;
      color: #7dd3fc;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 6px;
    }
    .metric {
      background: #020617;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid #1f2937;
      text-align: center;
    }
    .metric-label {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .metric-value {
      font-size: 1.2rem;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.8rem;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #1f2937;
      text-align: right;
    }
    th {
      background: #020617;
      color: #7dd3fc;
      font-weight: 500;
    }
    tr:hover {
      background: #111827;
    }
    .bar-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .bar-track {
      flex: 1;
      height: 8px;
      background: #020617;
      border-radius: 999px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #38bdf8, #22c55e);
    }
    .bar-label {
      min-width: 42px;
      text-align: left;
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid #4b5563;
      color: #e5e7eb;
    }
    .btn-link {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #38bdf8;
      color: #38bdf8;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .section-title-sm {
      font-size: 0.85rem;
      margin: 10px 0 4px;
      color: #9ca3af;
    }
  </style>
</head>
<body>

  <h1>אנליטיקות – יערת העמק</h1>
  <div class="subtitle">
    מבוסס על Firestore – כניסות לפי דף, יום, שעה, שכבה וכיתה.
  </div>

  <div id="status" class="status">בודק הרשאות...</div>

  <div class="layout" id="layout" style="display:none;">
    <!-- צד שמאל – סיכום + לפי ימים -->
    <div>
      <div class="card">
        <h2>סיכום כללי</h2>
        <div class="metrics">
          <div class="metric">
            <div class="metric-label">סה"כ צפיות</div>
            <div class="metric-value" id="metric-total-views">-</div>
          </div>
          <div class="metric">
            <div class="metric-label">דפים שונים</div>
            <div class="metric-value" id="metric-unique-pages">-</div>
          </div>
          <div class="metric">
            <div class="metric-label">ימים עם פעילות</div>
            <div class="metric-value" id="metric-active-days">-</div>
          </div>
        </div>

        <div class="section-title-sm">דף "מבחנים" – צפיות (pageId = home-exams)</div>
        <div id="metric-exams-views" class="metric-value" style="font-size:1rem;">-</div>

        <div class="section-title-sm">דף "מבחנים לפי כיתה" – צפיות (pageId = class-exams)</div>
        <div id="metric-class-exams-views" class="metric-value" style="font-size:1rem;">-</div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>צפיות לפי יום (כל הדפים)</h2>
        <table>
          <thead>
            <tr>
              <th>תאריך</th>
              <th>צפיות</th>
              <th>גרף</th>
            </tr>
          </thead>
          <tbody id="table-by-day"></tbody>
        </table>
      </div>
    </div>

    <!-- צד ימין – לפי דפים / שעות / שכבות / כיתות -->
    <div>
      <div class="card">
        <h2>צפיות לפי דף</h2>
        <table>
          <thead>
            <tr>
              <th>דף</th>
              <th>צפיות</th>
            </tr>
          </thead>
          <tbody id="table-by-page"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>פעילות לפי שעה / שכבה / כיתה</h2>

        <div class="section-title-sm">לפי שעה (כל הדפים)</div>
        <table>
          <thead>
            <tr>
              <th>שעה</th>
              <th>צפיות</th>
              <th>פס</th>
            </tr>
          </thead>
          <tbody id="table-by-hour"></tbody>
        </table>

        <div class="section-title-sm">לפי שכבה – כל הדפים</div>
        <table>
          <thead>
            <tr>
              <th>שכבה</th>
              <th>צפיות</th>
            </tr>
          </thead>
          <tbody id="table-by-grade"></tbody>
        </table>

        <div class="section-title-sm">לפי כיתה – כל הדפים</div>
        <table>
          <thead>
            <tr>
              <th>כיתה</th>
              <th>צפיות</th>
            </tr>
          </thead>
          <tbody id="table-by-class"></tbody>
        </table>

        <div class="section-title-sm">דף המבחנים הראשי – לפי שכבה</div>
        <table>
          <thead>
            <tr>
              <th>שכבה</th>
              <th>צפיות (home-exams)</th>
            </tr>
          </thead>
          <tbody id="table-exams-by-grade"></tbody>
        </table>

        <div class="section-title-sm">דף "מבחנים לפי כיתה" – לפי כיתה</div>
        <table>
          <thead>
            <tr>
              <th>כיתה</th>
              <th>צפיות (class-exams)</th>
            </tr>
          </thead>
          <tbody id="table-classExams-by-class"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from "./firebase-config.js";
    import {
      collection,
      getDocs,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import {
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const OWNER_EMAILS = ["nadavp1119@gmail.com"];

    const statusEl = document.getElementById("status");
    const layoutEl = document.getElementById("layout");

    const elTotalViews = document.getElementById("metric-total-views");
    const elUniquePages = document.getElementById("metric-unique-pages");
    const elActiveDays = document.getElementById("metric-active-days");
    const elExamsViews = document.getElementById("metric-exams-views");
    const elClassExamsViews = document.getElementById("metric-class-exams-views");

    const tbodyByDay = document.getElementById("table-by-day");
    const tbodyByPage = document.getElementById("table-by-page");
    const tbodyByHour = document.getElementById("table-by-hour");
    const tbodyByGrade = document.getElementById("table-by-grade");
    const tbodyByClass = document.getElementById("table-by-class");
    const tbodyExamsByGrade = document.getElementById("table-exams-by-grade");
    const tbodyClassExamsByClass = document.getElementById("table-classExams-by-class");

    function humanPageId(pageId) {
      if (!pageId) return "-";
      const map = {
        "home": "דף הבית",
        "home-exams": "לוח מבחנים (עמוד ראשי)",
        "class-exams": "מבחנים לפי כיתה",
        "admin": "פאנל ניהול",
        "logs": "לוגים"
      };
      return map[pageId] || pageId;
    }

    function classIdToLabel(classId) {
      const map = {
        z1: "ז1", z2: "ז2", z3: "ז3", z4: "ז4", z5: "ז5",
        h1: "ח1", h2: "ח2", h3: "ח3", h4: "ח4", h5: "ח5", h6: "ח6",
        t1: "ט1", t2: "ט2", t3: "ט3", t4: "ט4", t5: "ט5"
      };
      return map[classId] || classId || "-";
    }

    function gradeToLabel(grade) {
      const map = { z: "ז", h: "ח", t: "ט" };
      return map[grade] || grade || "-";
    }

    function renderBarCell(value, max) {
      const pct = !max ? 0 : Math.max(5, Math.round((value / max) * 100));
      return `
        <div class="bar-row">
          <div class="bar-track">
            <div class="bar-fill" style="width:${pct}%;"></div>
          </div>
          <div class="bar-label">${value}</div>
        </div>
      `;
    }

    async function loadAnalytics() {
      // --------- pageViews (אגרגציה לפי דף+תאריך) ----------
      const qViews = query(
        collection(db, "analytics_pageViews"),
        orderBy("dateKey", "asc")
      );
      const snapViews = await getDocs(qViews);
      const viewsRows = snapViews.docs.map(d => d.data());

      let totalViews = 0;
      const pagesSet = new Set();
      const daysMap = new Map();   // dateKey -> sum
      const pagesMap = new Map();  // pageId -> sum

      viewsRows.forEach(r => {
        const v = Number(r.views || 0);
        totalViews += v;

        if (r.pageId) pagesSet.add(r.pageId);

        if (r.dateKey) {
          daysMap.set(r.dateKey, (daysMap.get(r.dateKey) || 0) + v);
        }
        if (r.pageId) {
          pagesMap.set(r.pageId, (pagesMap.get(r.pageId) || 0) + v);
        }
      });

      const examsViews = pagesMap.get("home-exams") || 0;
      const classExamsViews = pagesMap.get("class-exams") || 0;

      elTotalViews.textContent = totalViews.toString();
      elUniquePages.textContent = pagesSet.size.toString();
      elActiveDays.textContent = daysMap.size.toString();
      elExamsViews.textContent = examsViews.toString();
      elClassExamsViews.textContent = classExamsViews.toString();

      // טבלת לפי ימים
      const daysArr = Array.from(daysMap.entries())
        .map(([dateKey, views]) => ({ dateKey, views }))
        .sort((a, b) => (a.dateKey > b.dateKey ? -1 : 1));

      const maxDayViews = daysArr.reduce((m, r) => Math.max(m, r.views), 0);
      tbodyByDay.innerHTML = "";
      if (!daysArr.length) {
        tbodyByDay.innerHTML = `<tr><td colspan="3">אין נתונים עדיין.</td></tr>`;
      } else {
        daysArr.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.dateKey}</td>
            <td>${r.views}</td>
            <td>${renderBarCell(r.views, maxDayViews)}</td>
          `;
          tbodyByDay.appendChild(tr);
        });
      }

      // טבלת לפי דפים
      const pagesArr = Array.from(pagesMap.entries())
        .map(([pageId, views]) => ({ pageId, views }))
        .sort((a, b) => b.views - a.views);

      tbodyByPage.innerHTML = "";
      if (!pagesArr.length) {
        tbodyByPage.innerHTML = `<tr><td colspan="2">אין נתונים עדיין.</td></tr>`;
      } else {
        pagesArr.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${humanPageId(r.pageId)}</td>
            <td>${r.views}</td>
          `;
          tbodyByPage.appendChild(tr);
        });
      }

      // --------- events (שעה / שכבה / כיתה / דפים ספציפיים) ----------
      const qEvents = query(
        collection(db, "analytics_events"),
        orderBy("dateKey", "desc")
      );
      const snapEvents = await getDocs(qEvents);
      const events = snapEvents.docs.map(d => d.data());

      const hourMap = new Map();        // "00".."23" -> count
      const gradeMap = new Map();       // grade -> count (כל הדפים)
      const classMap = new Map();       // classId -> count (כל הדפים)
      const examsByGrade = new Map();   // grade -> count (רק home-exams)
      const classExamsByClass = new Map(); // classId -> count (רק class-exams)

      events.forEach(ev => {
        const h = ev.hour || "??";
        hourMap.set(h, (hourMap.get(h) || 0) + 1);

        if (ev.grade) {
          gradeMap.set(ev.grade, (gradeMap.get(ev.grade) || 0) + 1);
        }
        if (ev.classId) {
          classMap.set(ev.classId, (classMap.get(ev.classId) || 0) + 1);
        }

        if (ev.pageId === "home-exams" && ev.grade) {
          examsByGrade.set(ev.grade, (examsByGrade.get(ev.grade) || 0) + 1);
        }

        if (ev.pageId === "class-exams" && ev.classId) {
          classExamsByClass.set(ev.classId, (classExamsByClass.get(ev.classId) || 0) + 1);
        }
      });

      // לפי שעה
      const hourArr = Array.from(hourMap.entries())
        .map(([hour, count]) => ({ hour, count }))
        .sort((a, b) => a.hour.localeCompare(b.hour));

      const maxHour = hourArr.reduce((m, r) => Math.max(m, r.count), 0);
      tbodyByHour.innerHTML = "";
      if (!hourArr.length) {
        tbodyByHour.innerHTML = `<tr><td colspan="3">אין עדיין נתוני שעות.</td></tr>`;
      } else {
        hourArr.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.hour}:00</td>
            <td>${r.count}</td>
            <td>${renderBarCell(r.count, maxHour)}</td>
          `;
          tbodyByHour.appendChild(tr);
        });
      }

      // לפי שכבה – כל הדפים
      const gradeArr = Array.from(gradeMap.entries())
        .map(([grade, count]) => ({ grade, count }))
        .sort((a, b) => b.count - a.count);

      tbodyByGrade.innerHTML = "";
      if (!gradeArr.length) {
        tbodyByGrade.innerHTML = `<tr><td colspan="2">אין עדיין פעילויות עם grade.</td></tr>`;
      } else {
        gradeArr.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="pill">${gradeToLabel(r.grade)}</span></td>
            <td>${r.count}</td>
          `;
          tbodyByGrade.appendChild(tr);
        });
      }

      // לפי כיתה – כל הדפים
      const classArr = Array.from(classMap.entries())
        .map(([classId, count]) => ({ classId, count }))
        .sort((a, b) => b.count - a.count);

      tbodyByClass.innerHTML = "";
      if (!classArr.length) {
        tbodyByClass.innerHTML = `<tr><td colspan="2">אין עדיין פעילויות עם classId.</td></tr>`;
      } else {
        classArr.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="pill">${classIdToLabel(r.classId)}</span></td>
            <td>${r.count}</td>
          `;
          tbodyByClass.appendChild(tr);
        });
      }

      // דף המבחנים הראשי – לפי שכבה
      const examsGradeArr = Array.from(examsByGrade.entries())
        .map(([grade, count]) => ({ grade, count }))
        .sort((a, b) => b.count - a.count);

      tbodyExamsByGrade.innerHTML = "";
      if (!examsGradeArr.length) {
        tbodyExamsByGrade.innerHTML = `<tr><td colspan="2">אין עדיין צפיות בדף המבחנים הראשי עם grade.</td></tr>`;
      } else {
        examsGradeArr.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="pill">${gradeToLabel(r.grade)}</span></td>
            <td>${r.count}</td>
          `;
          tbodyExamsByGrade.appendChild(tr);
        });
      }

      // דף "מבחנים לפי כיתה" – לפי כיתה
      const classExamsArr = Array.from(classExamsByClass.entries())
        .map(([classId, count]) => ({ classId, count }))
        .sort((a, b) => b.count - a.count);

      tbodyClassExamsByClass.innerHTML = "";
      if (!classExamsArr.length) {
        tbodyClassExamsByClass.innerHTML = `<tr><td colspan="2">אין עדיין צפיות בעמוד class-exams עם classId.</td></tr>`;
      } else {
        classExamsArr.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="pill">${classIdToLabel(r.classId)}</span></td>
            <td>${r.count}</td>
          `;
          tbodyClassExamsByClass.appendChild(tr);
        });
      }

      statusEl.textContent = "נטען בהצלחה.";
      layoutEl.style.display = "";
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        statusEl.classList.add("error");
        statusEl.innerHTML = `
          אין לך גישה. התחבר דרך עמוד הניהול.<br>
          <a class="btn-link" href="admin.html">לעמוד ההתחברות</a>
        `;
        return;
      }

      const email = (user.email || "").toLowerCase();
      const allowed = OWNER_EMAILS.map(e => e.toLowerCase()).includes(email);

      if (!allowed) {
        statusEl.classList.add("error");
        statusEl.textContent =
          "המשתמש " + email + " אינו מורשה לצפות באנליטיקות.";
        return;
      }

      statusEl.textContent = "טוען נתונים...";
      loadAnalytics().catch(err => {
        console.error(err);
        statusEl.classList.add("error");
        statusEl.textContent = "שגיאה בטעינת הנתונים.";
      });
    });
  </script>
</body>
</html>
